<!DOCTYPE html>
<html lang="zh-CN">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>擢升一瞥 - 游戏界面</title>
    <script src="src/js/dataManager.js"></script>
    <script src="src/js/responseParser.js"></script>
    <script src="src/js/engine.js"></script>
    <script src="src/js/storyStorage.js"></script>
    <script src="src/js/promptManager.js"></script>
    <script src="src/js/promptBuilder_storyteller.js"></script>
    <script src="src/js/promptBuilder_recorder.js"></script>
    <script src="src/js/contextCompressor.js"></script>
    <script src="src/js/debugPanel.js"></script>
    <style>

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            background-color: white;
            color: #4CAF50;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            text-decoration: none;
        }
        
        .btn:hover {
            background-color: #f0f0f0;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .message {
            margin-bottom: 15px;
            max-width: 100%;
            word-wrap: break-word;
        }
        
        .message.user {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border-radius: 18px;
            align-self: flex-end;
            margin-left: auto;
            max-width: 80%;
        }
        
        .message.ai {
            color: #333;
            align-self: flex-start;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
        }
        
        #message-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            resize: none;
            outline: none;
        }
        
        #send-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #send-btn:hover {
            background-color: #45a049;
        }
        
        /* 调试悬浮窗样式 */
        .debug-panel {
            position: fixed;
            top: 70px;
            left: 20px;
            width: 320px;
            max-height: 400px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow: hidden;
        }
        
        .debug-panel-header {
            padding: 10px 10px 0 10px;
        }
        
        .debug-panel h3 {
            margin-top: 0;
            color: #4CAF50;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        /* 选项卡样式 */
        .debug-tabs {
            display: flex;
            margin: 0 10px;
            border-bottom: 1px solid #555;
            flex-wrap: wrap;
        }
        
        .debug-tab {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 11px;
            color: #aaa;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }
        
        .debug-tab.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
        }
        
        .debug-tab-content {
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .debug-section {
            margin-bottom: 12px;
        }
        
        .debug-section h4 {
            margin: 0 0 5px 0;
            font-size: 12px;
            color: #aaa;
        }
        
        .debug-content {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 8px;
            font-size: 11px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* 引擎工具按钮样式 */
        .engine-tool-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            transition: background-color 0.3s;
        }
        
        .engine-tool-btn:hover {
            background-color: #45a049;
        }
        
        .engine-tool-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        .debug-toggle {
            position: fixed;
            top: 70px;
            left: 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 11px;
            z-index: 1001;
        }
        
        /* 游戏数据显示样式 */
        .game-data-display {
            font-size: 11px;
            line-height: 1.4;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .debug-panel {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
            }
            
            .debug-tabs {
                justify-content: center;
            }
            
            .debug-tab {
                font-size: 10px;
                padding: 5px 10px;
            }
        }
        
        .debug-toggle:hover {
            background-color: #45a049;
        }
        
        /* 成就悬浮窗样式 */
        .achievements-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background-color: white;
            color: #333;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            z-index: 999;
            overflow-y: auto;
            display: none;
        }
        
        .achievements-panel h3 {
            margin-top: 0;
            color: #4CAF50;
            font-size: 18px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .achievement-item {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            border-left: 4px solid #4CAF50;
        }
        
        .achievement-item.completed {
            background-color: #e8f5e8;
            border-left-color: #4CAF50;
        }
        
        .achievement-item.hidden {
            background-color: #f5f5f5;
            border-left-color: #999;
        }
        
        .achievement-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .achievement-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        /* 加载等待条样式 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            font-size: 18px;
            flex-direction: column;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #4CAF50;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="btn">返回首页</a>
        <span>擢升一瞥</span>
        <div class="header-buttons">
            <button class="btn achievements-toggle" onclick="toggleAchievementsPanel()">成就</button>
            <a href="settings.html" class="btn">设置</a>
        </div>
    </div>
    
    <div class="chat-container">
        <div class="messages" id="messages">
            <div class="message ai">
                欢迎来到擢升一瞥的调试开发界面。我是你的AI助手，将会帮助你完成这个网页游戏的开发。
            </div>
        </div>
        
        <div class="input-area">
            <div style="position: relative; flex: 1;">
                <textarea id="message-input" placeholder="输入你的消息..." rows="1" maxlength="500"></textarea>
                <div style="position: absolute; bottom: 10px; right: 10px; font-size: 12px; color: #999;" id="char-count">0/500</div>
            </div>
            <button id="send-btn">➤</button>
        </div>
    </div>
    
    <!-- 调试悬浮窗 -->
    <button class="debug-toggle" onclick="toggleDebugPanel()">调试面板</button>
    <div class="debug-panel" id="debugPanel" style="display: none;">
        <div class="debug-panel-header">
            <h3>调试信息</h3>
        </div>
        <div class="debug-tabs">
            <div class="debug-tab" onclick="switchDebugTab('engine-tools')">引擎工具</div>
            <div class="debug-tab active" onclick="switchDebugTab('ai-data')">AI输入/输出</div>
            <div class="debug-tab" onclick="switchDebugTab('phase1')">阶段一 (故事讲述者)</div>
            <div class="debug-tab" onclick="switchDebugTab('phase2')">阶段二 (故事记录者)</div>
            <div class="debug-tab" onclick="switchDebugTab('game-data')">游戏数据</div>
        </div>
        <div class="debug-tab-content" id="engine-tools-tab" style="display: none;">
            <div class="debug-section">
                <h4>节拍操作</h4>
                <div class="game-data-display" id="beat-data-display" style="margin-bottom: 10px; padding: 8px; background-color: rgba(255, 255, 255, 0.1); border-radius: 4px;">
                    当前节拍：<span id="current-beat">加载中...</span><br>
                    节拍操作：<span id="current-beat-operation">加载中...</span>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                    <button class="engine-tool-btn" onclick="executeEngineTool('update', 'narrative.storyBeatOperation', '推进')">推进</button>
                    <button class="engine-tool-btn" onclick="executeEngineTool('update', 'narrative.storyBeatOperation', '维持')">维持</button>
                    <button class="engine-tool-btn" onclick="executeEngineTool('update', 'narrative.storyBeatOperation', '完结')">完结</button>
                </div>
            </div>
            <div class="debug-section">
                <h4>景深等级</h4>
                <div class="game-data-display" id="depth-data-display" style="margin-bottom: 10px; padding: 8px; background-color: rgba(255, 255, 255, 0.1); border-radius: 4px;">
                    当前景深等级：<span id="current-depth-level">加载中...</span>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                    <button class="engine-tool-btn" onclick="executeEngineTool('update', 'narrative.depthLevel', '1')">景深 1</button>
                    <button class="engine-tool-btn" onclick="executeEngineTool('update', 'narrative.depthLevel', '2')">景深 2</button>
                    <button class="engine-tool-btn" onclick="executeEngineTool('update', 'narrative.depthLevel', '3')">景深 3</button>
                    <button class="engine-tool-btn" onclick="executeEngineTool('update', 'narrative.depthLevel', '4')">景深 4</button>
                    <button class="engine-tool-btn" onclick="executeEngineTool('update', 'narrative.depthLevel', '5')">景深 5</button>
                </div>
            </div>
            <div class="debug-section">
                <h4>时间设置</h4>
                <div class="game-data-display" id="time-data-display" style="margin-bottom: 10px; padding: 8px; background-color: rgba(255, 255, 255, 0.1); border-radius: 4px;">
                    当前时间：<span id="current-time">加载中...</span>
                </div>
                <div style="margin-bottom: 10px;">
                    <input type="datetime-local" id="time-input" style="width: 100%; padding: 8px; margin-bottom: 8px;" />
                    <button class="engine-tool-btn" onclick="executeTimeTool()">设置时间</button>
                </div>
            </div>
            <div class="debug-section">
                <h4>事件操作</h4>
                <button class="engine-tool-btn" onclick="toggleEventForm()">注册/更新事件</button>
                <div id="event-form" style="display: none; margin-top: 10px; padding: 10px; background-color: rgba(255, 255, 255, 0.1); border-radius: 5px;">
                    <input type="text" id="event-name" placeholder="事件名称" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <textarea id="event-description" placeholder="事件描述" rows="2" style="width: 100%; padding: 6px; margin-bottom: 6px;" ></textarea>
                    <input type="datetime-local" id="event-start-time" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <input type="datetime-local" id="event-end-time" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <input type="number" id="event-importance" placeholder="重要程度 (1-5)" min="1" max="5" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <button class="engine-tool-btn" onclick="executeEventTool('registerEvent')">注册事件</button>
                </div>
                <div style="margin-top: 10px;">
                    <input type="text" id="delete-event-name" placeholder="事件名称" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <button class="engine-tool-btn" onclick="executeEngineTool('deleteEvent', null, document.getElementById('delete-event-name').value)">删除事件</button>
                </div>
            </div>
            <div class="debug-section">
                <h4>成就操作</h4>
                <input type="text" id="achievement-name" placeholder="成就名称" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                <div style="display: flex; gap: 8px;">
                    <button class="engine-tool-btn" onclick="executeEngineTool('completeAchievement', null, document.getElementById('achievement-name').value)">完成成就</button>
                    <button class="engine-tool-btn" onclick="executeEngineTool('showAchievement', null, document.getElementById('achievement-name').value)">显示成就</button>
                </div>
            </div>
            <div class="debug-section">
                <h4>伏笔操作</h4>
                <button class="engine-tool-btn" onclick="toggleForeshadowingForm()">添加/更新伏笔</button>
                <div id="foreshadowing-form" style="display: none; margin-top: 10px; padding: 10px; background-color: rgba(255, 255, 255, 0.1); border-radius: 5px;">
                    <input type="text" id="foreshadowing-name" placeholder="伏笔名称" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <textarea id="foreshadowing-description" placeholder="伏笔描述" rows="2" style="width: 100%; padding: 6px; margin-bottom: 6px;" ></textarea>
                    <input type="datetime-local" id="foreshadowing-time" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <input type="number" id="foreshadowing-importance" placeholder="重要程度 (1-5)" min="1" max="5" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <button class="engine-tool-btn" onclick="executeForeshadowingTool('addForeshadowing')">添加伏笔</button>
                </div>
                <div style="margin-top: 10px;">
                    <input type="text" id="delete-foreshadowing-name" placeholder="伏笔名称" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <button class="engine-tool-btn" onclick="executeEngineTool('removeForeshadowing', null, document.getElementById('delete-foreshadowing-name').value)">删除伏笔</button>
                </div>
            </div>
        </div>
        <div class="debug-tab-content" id="ai-data-tab">
            <div class="debug-section">
                <h4>AI输入/输出</h4>
                <div class="debug-section">
                    <h5>输入 (发送给AI)</h5>
                    <div class="debug-content" id="aiInput">无数据</div>
                </div>
                <div class="debug-section">
                    <h5>输出 (AI回复)</h5>
                    <div class="debug-content" id="aiOutput">无数据</div>
                </div>
            </div>
        </div>
        <div class="debug-tab-content" id="phase1-tab" style="display: none;">
            <div class="debug-section">
                <h4>阶段一 - 故事讲述者</h4>
                <div class="debug-section">
                    <h5>输入 (发送给AI)</h5>
                    <div class="debug-content" id="phase1Input">无数据</div>
                </div>
                <div class="debug-section">
                    <h5>输出 (AI回复)</h5>
                    <div class="debug-content" id="phase1Output">无数据</div>
                </div>
            </div>
        </div>
        <div class="debug-tab-content" id="phase2-tab" style="display: none;">
            <div class="debug-section">
                <h4>阶段二 - 故事记录者</h4>
                <div class="debug-section">
                    <h5>输入 (发送给AI)</h5>
                    <div class="debug-content" id="phase2Input">无数据</div>
                </div>
                <div class="debug-section">
                    <h5>输出 (AI回复)</h5>
                    <div class="debug-content" id="phase2Output">无数据</div>
                </div>
            </div>
        </div>
        <div class="debug-tab-content" id="game-data-tab" style="display: none;">
            <div class="debug-section">
                <h4>data.json内容</h4>
                <div class="debug-content" id="dataJsonContent">加载中...</div>
            </div>
        </div>
    </div>
    
    <!-- 成就悬浮窗 -->
    <div class="achievements-panel" id="achievementsPanel">
        <h3>成就列表</h3>
        <div class="achievements-content" id="achievementsContent">
            <div class="loading">加载成就中...</div>
        </div>
    </div>
    
    <!-- 加载等待条 -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">世界加载中...</div>
    </div>
    
    <script>
        // 全局调试属性
        const admin = true;
        // 防止修改
        Object.defineProperty(window, 'admin', {
            value: true,
            writable: false,
            configurable: false
        });
        
        // 显示加载等待条
        function showLoading(text = '世界加载中...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            if (overlay && loadingText) {
                loadingText.textContent = text;
                overlay.style.display = 'flex';
            }
        }
        
        // 隐藏加载等待条
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }
        
        // 调试数据存储
        let debugData = {
            phase1: {
                input: null,
                output: null
            },
            phase2: {
                input: null,
                output: null
            },
            lastAiResponse: null,
            lastApiRequest: null,
            dataJson: null
        };
        
        // 页面加载时检查admin权限并隐藏调试按钮
        window.addEventListener('load', function() {
            if (typeof admin === 'undefined' || !admin) {
                debugToggle.style.display = 'none';
            } else {
                // 加载data.json内容
                loadDataJson();
            }
        });
        
        // 加载data.json内容
        async function loadDataJson() {
            try {
                const response = await fetch('src/data/data.json');
                if (response.ok) {
                    const data = await response.json();
                    debugData.dataJson = JSON.stringify(data, null, 2);
                    if (window.DebugPanelInstance) {
                        window.DebugPanelInstance.updateContent();
                    }
                } else {
                    throw new Error('加载失败');
                }
            } catch (error) {
                console.error('加载data.json失败:', error);
                debugData.dataJson = '加载失败: ' + error.message;
                if (window.DebugPanelInstance) {
                    window.DebugPanelInstance.updateContent();
                }
            }
        }
        
        // 故事数据
        let fullStory = []; // 完整故事，不做删减
        let compressedStory = []; // 压缩故事（由摘要组成）
        let uncompressedStory = []; // 未压缩故事（实时故事）
        let latestUserMessage = null; // 最新用户消息
        
        // 检查API密钥状态并更新UI
        function checkApiKeyStatus() {
            // 从本地存储获取API密钥
            const savedSettings = localStorage.getItem('gameSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                if (settings.apiKey) {
                    // 有API密钥，启用控件
                    sendBtn.disabled = false;
                    messageInput.disabled = false;
                    return true;
                }
            }
            // 没有API密钥，禁用控件
            sendBtn.disabled = true;
            messageInput.disabled = true;
            return false;
        }

        // 初始化函数
        async function init() {
            // 检查是否是新游戏
            checkForNewGame();
            
            // 检查API密钥状态
            const hasApiKey = checkApiKeyStatus();
            if (!hasApiKey) {
                addMessage('请先在设置页面配置DeepSeek API密钥', false);
            }
            
            // 加载存储的故事数据
            loadStoryData();
            
            // 启动游戏引擎
            startEngine();
            
            // 加载成就数据
            await loadAchievementsData();
        }
        
        // 检查是否是新游戏
        function checkForNewGame() {
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const newGame = urlParams.get('newgame');
            
            if (newGame === 'true') {
                // 清空所有故事数据
                StoryStorage.clearAll();
                console.log('已清空所有故事数据，开始新游戏');
            }
        }
        
        // 加载故事数据
        function loadStoryData() {
            // 从StoryStorage加载数据
            const storyData = StoryStorage.loadAll();
            
            fullStory = storyData.fullStory || [];
            compressedStory = storyData.compressedStory || [];
            uncompressedStory = storyData.uncompressedStory || [];
            latestUserMessage = storyData.latestUserMessage;
            
            // 显示未压缩故事（实时故事）给玩家
            displayUncompressedStory();
        }
        
        // 显示未压缩故事（实时故事）给玩家
        function displayUncompressedStory() {
            if (uncompressedStory.length > 0) {
                // 清空现有消息
                messagesContainer.innerHTML = '';
                
                // 显示未压缩故事
                uncompressedStory.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.role === 'user' ? 'user' : 'ai'}`;
                    messageDiv.textContent = msg.content;
                    messagesContainer.appendChild(messageDiv);
                });
                
                // 滚动到底部
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                console.log('已显示未压缩故事，消息数:', uncompressedStory.length);
            }
        }
        
        // 启动游戏引擎
        async function startEngine() {
            console.log('开始启动游戏引擎');
            try {
                // 初始化游戏引擎
                const initResult = await GameEngineInstance.initialize();
                if (initResult.success) {
                    console.log('游戏引擎初始化成功:', initResult.message);
                    // 获取引擎状态
                    const status = GameEngineInstance.getStatus();
                    console.log('游戏引擎状态:', status);
                } else {
                    console.error('游戏引擎初始化失败:', initResult.error);
                }
            } catch (error) {
                console.error('启动游戏引擎错误:', error);
            }
        }
        
        // 添加消息到聊天界面
        async function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            messageDiv.textContent = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // 计算消息字数
            const messageWordCount = content.length;
            
            // 创建未压缩故事的消息对象（包含时间戳）
            const uncompressedMessageObj = { 
                role: isUser ? 'user' : 'assistant', 
                content: content,
                timestamp: new Date().toISOString(),
                wordCount: messageWordCount
            };
            
            // 创建完整故事的消息对象（不包含时间戳）
            const fullMessageObj = { 
                role: isUser ? 'user' : 'assistant', 
                content: content
            };
            
            // 更新未压缩故事（实时故事）- 包含时间戳
            uncompressedStory.push(uncompressedMessageObj);
            
            // 更新完整故事 - 不包含时间戳
            fullStory.push(fullMessageObj);
            
            // 如果是用户消息，更新最新用户消息
            if (isUser) {
                latestUserMessage = uncompressedMessageObj;
            }
            
            // 更新字数统计
            if (!isUser) { // 只统计AI的故事内容
                try {
                    // 获取当前游戏数据
                    const gameData = GameEngineInstance.getGameData();
                    
                    // 计算当前节拍
                    const currentBeat = gameData.narrative?.storyBeat || '起';
                    
                    // 更新当前节拍的字数
                    if (gameData.narrative?.beatStats?.current) {
                        gameData.narrative.beatStats.current[currentBeat] = 
                            (gameData.narrative.beatStats.current[currentBeat] || 0) + messageWordCount;
                    }
                    
                    // 更新当前循环字数
                    gameData.narrative.currentCycleWords = 
                        (gameData.narrative.currentCycleWords || 0) + messageWordCount;
                    
                    // 更新总字数
                    gameData.narrative.totalWords = 
                        (gameData.narrative.totalWords || 0) + messageWordCount;
                    
                    // 保存更新后的数据
                    await GameEngineInstance.saveGameData();
                    
                    console.log(`字数统计更新：当前节拍[${currentBeat}]增加${messageWordCount}字，总字数${gameData.narrative.totalWords}`);
                } catch (error) {
                    console.error('更新字数统计失败:', error);
                }
            }
            
            // 检查是否需要压缩上下文
            if (ContextCompressor.shouldCompress(uncompressedStory)) {
                console.log('检测到未压缩消息数达到阈值，准备进行压缩');
                
                // 从本地存储获取API密钥
                const savedSettings = localStorage.getItem('gameSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    const apiKey = settings.apiKey;
                    
                    if (apiKey) {
                        try {
                            // 压缩最早的16条消息
                        const messagesToCompress = uncompressedStory.slice(0, 16);
                        const compressedMessage = await ContextCompressor.compressContext(messagesToCompress, apiKey);
                        if (compressedMessage) {
                            // 更新压缩故事
                            compressedStory.push(compressedMessage);
                            
                            // 保留最后8条未压缩消息作为叙事风格稳定器
                            uncompressedStory = uncompressedStory.slice(16);
                            
                            console.log('上下文压缩完成，压缩故事数:', compressedStory.length, '保留的未压缩故事数:', uncompressedStory.length);
                        }
                        } catch (error) {
                            console.error('压缩上下文失败:', error);
                        }
                    }
                }
            }
            
            // 保存所有故事数据
            saveStoryData();
            
            // 输出故事数据状态
            console.log('故事数据状态：完整故事长度:', fullStory.length, '压缩故事长度:', compressedStory.length, '未压缩故事长度:', uncompressedStory.length);
        }
        
        // 保存故事数据
        function saveStoryData() {
            StoryStorage.saveAll(fullStory, compressedStory, uncompressedStory, latestUserMessage);
        }
        
        // 发送消息
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                // 添加用户消息
                await addMessage(message, true);
                messageInput.value = '';
                
                // 禁用发送按钮和输入框，防止重复发送
                sendBtn.disabled = true;
                sendBtn.textContent = '...';
                messageInput.disabled = true;
                
                try {
                    // 检查当前模式
                    const currentMode = PromptManager.getCurrentMode();
                    
                    if (currentMode === 'twoPhase') {
                        // 使用两阶段模式
                        await sendMessageTwoPhase(message);
                    } else {
                        // 使用简略模式
                        // 调用DeepSeek API获取回复
                        const aiResponse = await callDeepSeekAPI(message);
                        
                        // 使用游戏引擎处理AI响应
                        const processResult = await GameEngineInstance.processAIResponse(aiResponse);
                        
                        // 添加处理后的故事到聊天界面
                        await addMessage(processResult.story);
                    }
                } catch (error) {
                    console.error('调用API失败:', error);
                    await addMessage('抱歉，AI回复失败，请稍后重试。', false);
                } finally {
                    // 恢复发送按钮和输入框
                    sendBtn.disabled = false;
                    sendBtn.textContent = '➤';
                    messageInput.disabled = false;
                }
            }
        }
        
        // 两阶段交互逻辑
        async function sendMessageTwoPhase(message) {
            try {
                // 阶段一：故事讲述者
                showLoading('世界加载中...');
                
                // 调用故事讲述者API
                const storytellerResult = await callStorytellerAPI(message);
                
                // 添加故事到聊天界面
                await addMessage(storytellerResult.story);
                
                // 阶段二：故事记录者
                showLoading('世界解算中...');
                
                // 调用故事记录者API
                const recorderResult = await callRecorderAPI(storytellerResult.story, storytellerResult.secretInfo);
                
                // 使用游戏引擎处理记录者响应
                const processResult = await GameEngineInstance.processAIResponse(recorderResult);
                
                console.log('两阶段交互完成');
            } finally {
                hideLoading();
            }
        }
        
        // 简略模式逻辑
        async function sendMessageSimplified(message) {
            try {
                // 调用DeepSeek API获取回复
                const aiResponse = await callDeepSeekAPI(message);
                
                // 使用游戏引擎处理AI响应
                const processResult = await GameEngineInstance.processAIResponse(aiResponse);
                
                // 添加处理后的故事到聊天界面
                await addMessage(processResult.story);
            } catch (error) {
                console.error('调用DeepSeek API失败:', error);
                throw error;
            }
        }
        
        // 调用故事讲述者API - 第一阶段
        async function callStorytellerAPI(userMessage) {
            // 从本地存储获取API密钥
            const savedSettings = localStorage.getItem('gameSettings');
            if (!savedSettings) {
                throw new Error('请先在设置页面配置DeepSeek API密钥');
            }
            
            const settings = JSON.parse(savedSettings);
            const apiKey = settings.apiKey;
            
            if (!apiKey) {
                throw new Error('请先在设置页面配置DeepSeek API密钥');
            }
            
            // 使用PromptBuilder_Storyteller准备请求数据并发送API请求
            const { requestData, apiKey: finalApiKey } = await PromptBuilder_Storyteller.prepareRequestData(
                apiKey, 
                userMessage, 
                compressedStory, 
                uncompressedStory, 
                latestUserMessage
            );
            
            // 发送API请求
            const storytellerResult = await PromptBuilder_Storyteller.sendApiRequest(requestData, finalApiKey);
            
            // 存储完整请求数据到调试数据
            debugData.phase1.input = JSON.stringify(requestData, null, 2);
            debugData.phase1.output = storytellerResult.story;
            debugData.lastApiRequest = debugData.phase1.input;
            debugData.lastAiResponse = debugData.phase1.output;
            if (window.DebugPanelInstance) {
                window.DebugPanelInstance.updateContent();
            }
            
            // 更新调试面板显示
            updateDebugPanel();
            
            return storytellerResult;
        }
        
        // 调用故事记录者API - 第二阶段
        async function callRecorderAPI(story, secretInfo) {
            // 从本地存储获取API密钥
            const savedSettings = localStorage.getItem('gameSettings');
            if (!savedSettings) {
                throw new Error('请先在设置页面配置DeepSeek API密钥');
            }
            
            const settings = JSON.parse(savedSettings);
            const apiKey = settings.apiKey;
            
            if (!apiKey) {
                throw new Error('请先在设置页面配置DeepSeek API密钥');
            }
            
            // 使用PromptBuilder_Recorder准备请求数据并发送API请求
            const { requestData, apiKey: finalApiKey } = await PromptBuilder_Recorder.prepareRequestData(
                apiKey, 
                story, 
                secretInfo, 
                compressedStory, 
                uncompressedStory
            );
            
            const response = await PromptBuilder_Recorder.sendApiRequest(requestData, finalApiKey);
            
            // 存储完整请求数据到调试数据
            debugData.phase2.input = JSON.stringify(requestData, null, 2);
            debugData.phase2.output = response;
            debugData.lastApiRequest = debugData.phase2.input;
            debugData.lastAiResponse = debugData.phase2.output;
            if (window.DebugPanelInstance) {
                window.DebugPanelInstance.updateContent();
            }
            
            // 更新调试面板显示
            updateDebugPanel();
            
            return response;
        }
        
        // 调用DeepSeek API（简略模式）
        async function callDeepSeekAPI(userMessage) {
            // 从本地存储获取API密钥
            const savedSettings = localStorage.getItem('gameSettings');
            if (!savedSettings) {
                throw new Error('请先在设置页面配置DeepSeek API密钥');
            }
            
            const settings = JSON.parse(savedSettings);
            const apiKey = settings.apiKey;
            
            if (!apiKey) {
                throw new Error('请先在设置页面配置DeepSeek API密钥');
            }
            
            // 使用PromptManager加载简略模式提示词
            const prompts = await PromptManager.loadPrompts('simplified');
            
            // 拼装系统提示词
            let fullSystemPrompt = prompts.systemPrompt.trim();
            fullSystemPrompt += "\n\n===游戏规则部分结束===";
            
            if (prompts.loreContent) {
                fullSystemPrompt += "\n\n===世界设定部分开始===\n\n" + prompts.loreContent.trim();
                fullSystemPrompt += "\n\n===世界设定部分结束===";
            }
            
            if (prompts.dataContent) {
                fullSystemPrompt += "\n\n===数据部分开始===\n\n" + prompts.dataContent.trim();
                fullSystemPrompt += "\n\n===数据部分结束===";
            }
            
            // 准备请求数据
            const messages = [];
            if (fullSystemPrompt) {
                messages.push({ role: 'system', content: fullSystemPrompt });
            }
            
            if (compressedStory.length > 0) {
                messages.push({
                    role: 'system',
                    content: '===摘要部分开始==='
                });
                compressedStory.forEach(msg => {
                    if (msg && msg.content) {
                        messages.push({
                            role: msg.role || 'assistant',
                            content: msg.content
                        });
                    }
                });
                messages.push({
                    role: 'system',
                    content: '===摘要部分结束==='
                });
            }
            
            if (uncompressedStory.length > 0) {
                messages.push({
                    role: 'system',
                    content: '===故事部分开始==='
                });
                const storyToSend = uncompressedStory.slice(0, -1);
                storyToSend.forEach(msg => {
                    if (msg && msg.role && msg.content) {
                        messages.push({
                            role: msg.role,
                            content: msg.content
                        });
                    }
                });
                messages.push({
                    role: 'system',
                    content: '===故事部分结束==='
                });
            }
            
            if (userMessage) {
                messages.push({
                    role: 'system',
                    content: '===用户输入开始==='
                });
                messages.push({ role: 'user', content: userMessage });
                messages.push({
                    role: 'system',
                    content: '===用户输入结束===\n\n请以故事主持人的身份开始渲染故事，并使用游戏引擎更新和记录故事的状态。'
                });
            }
            
            const requestData = {
                model: 'deepseek-chat',
                messages: messages,
                temperature: 0.7,
                max_tokens: 8192
            };
            
            // 存储完整请求数据到调试数据
            debugData.lastApiRequest = JSON.stringify(requestData, null, 2);
            if (window.DebugPanelInstance) {
                window.DebugPanelInstance.updateContent();
            }
            
            // 更新调试面板显示
            updateDebugPanel();
            
            // 发送API请求
            const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
            }
            
            const responseData = await response.json();
            const content = responseData.choices[0].message.content;
            
            // 存储最后一次AI回复到调试数据
            debugData.lastAiResponse = content;
            if (window.DebugPanelInstance) {
                window.DebugPanelInstance.updateContent();
            }
            
            // 更新调试面板显示
            updateDebugPanel();
            
            return content;
        }
        

        
        // 事件监听
        sendBtn.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // 自动调整输入框高度并更新字数统计
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
            
            // 更新字数统计
            const charCount = document.getElementById('char-count');
            if (charCount) {
                const currentLength = messageInput.value.length;
                charCount.textContent = `${currentLength}/500`;
                // 当接近或达到字数限制时，改变颜色提醒用户
                if (currentLength >= 480) {
                    charCount.style.color = '#f44336';
                } else {
                    charCount.style.color = '#999';
                }
            }
        });
        
        // 页面加载完成后初始化
        window.addEventListener('load', function() {
            init();
            // 初始化调试面板选项卡显示状态
            updateDebugTabsVisibility();
        });
        
        // 当页面获得焦点时，重新检查API密钥状态
        window.addEventListener('focus', function() {
            const hasApiKey = checkApiKeyStatus();
            if (hasApiKey) {
                // 如果之前没有API密钥，现在有了，显示提示消息
                console.log('API密钥已配置，控件已启用');
            }
        });
        
        // 切换成就面板显示/隐藏
        function toggleAchievementsPanel() {
            if (achievementsPanel.style.display === 'none' || achievementsPanel.style.display === '') {
                achievementsPanel.style.display = 'block';
                // 每次打开时重新加载成就数据
                loadAchievementsData();
            } else {
                achievementsPanel.style.display = 'none';
            }
        }
        
        // 加载成就数据
        async function loadAchievementsData() {
            try {
                // 从游戏引擎获取成就数据
                const achievementsData = GameEngineInstance.getAchievementsData();
                if (achievementsData && achievementsData.achievements) {
                    displayAchievements(achievementsData.achievements);
                } else {
                    // 如果游戏引擎未初始化，尝试直接从文件加载
                    const response = await fetch('src/data/achievements.json');
                    if (response.ok) {
                        const data = await response.json();
                        displayAchievements(data.achievements);
                    } else {
                        throw new Error('加载成就数据失败');
                    }
                }
            } catch (error) {
                console.error('加载成就数据错误:', error);
                achievementsContent.innerHTML = '<div class="error">加载成就失败</div>';
            }
        }
        
        // 显示成就列表
        function displayAchievements(achievements) {
            if (!achievements || achievements.length === 0) {
                achievementsContent.innerHTML = '<div class="no-achievements">暂无成就</div>';
                return;
            }
            
            // 过滤出可见的成就
            const visibleAchievements = achievements.filter(achievement => !achievement.isHidden);
            
            if (visibleAchievements.length === 0) {
                achievementsContent.innerHTML = '<div class="no-achievements">暂无可见成就</div>';
                return;
            }
            
            // 按完成状态排序
            visibleAchievements.sort((a, b) => {
                if (a.isCompleted && !b.isCompleted) return -1;
                if (!a.isCompleted && b.isCompleted) return 1;
                return 0;
            });
            
            let html = '';
            
            visibleAchievements.forEach(achievement => {
                const className = `achievement-item ${achievement.isCompleted ? 'completed' : ''} ${achievement.isHidden ? 'hidden' : ''}`;
                const statusText = achievement.isCompleted ? '已完成' : '未完成';
                
                html += `
                    <div class="${className}">
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-description">${achievement.description}</div>
                        <div class="achievement-status">状态: ${statusText}</div>
                    </div>
                `;
            });
            
            achievementsContent.innerHTML = html;
        }
        
        // 切换调试面板显示/隐藏
        function toggleDebugPanel() {
            const debugPanel = document.getElementById('debugPanel');
            if (debugPanel.style.display === 'none' || debugPanel.style.display === '') {
                debugPanel.style.display = 'block';
                // 每次显示时更新调试面板内容
                updateDebugPanel();
                // 更新选项卡显示状态
                updateDebugTabsVisibility();
            } else {
                debugPanel.style.display = 'none';
            }
        }
        
        // 切换调试标签页
        function switchDebugTab(tabId) {
            // 隐藏所有标签页
            document.querySelectorAll('.debug-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // 移除所有标签页的活动状态
            document.querySelectorAll('.debug-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签页
            const tabContent = document.getElementById(tabId + '-tab');
            if (tabContent) {
                tabContent.style.display = 'block';
            }
            
            // 设置选中标签页的活动状态
            const tabButton = document.querySelector(`.debug-tab[onclick="switchDebugTab('${tabId}')"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }
        }
        
        // 更新调试选项卡显示状态
        function updateDebugTabsVisibility() {
            const currentMode = PromptManager.getCurrentMode();
            const isSimplified = currentMode === 'simplified';
            
            // 获取所有选项卡
            const tabs = document.querySelectorAll('.debug-tab');
            const tabContents = document.querySelectorAll('.debug-tab-content');
            
            // 显示/隐藏阶段标签页
            tabs.forEach(tab => {
                if (tab.onclick && (tab.onclick.toString().includes('phase1') || tab.onclick.toString().includes('phase2'))) {
                    tab.style.display = isSimplified ? 'none' : 'block';
                }
            });
            
            // 显示/隐藏阶段标签内容
            tabContents.forEach(content => {
                if (content.id === 'phase1-tab' || content.id === 'phase2-tab') {
                    content.style.display = 'none';
                }
            });
            
            // 确保当前显示的是正确的选项卡
            if (isSimplified) {
                switchDebugTab('ai-data');
            } else {
                switchDebugTab('phase1');
            }
        }
        
        // 更新调试面板内容
        function updateDebugPanel() {
            // 更新游戏数据显示
            if (debugData.dataJson) {
                document.getElementById('dataJsonContent').textContent = debugData.dataJson;
            }
            
            // 更新引擎工具标签页
            if (GameEngineInstance) {
                try {
                    const gameData = GameEngineInstance.getGameData();
                    document.getElementById('current-beat').textContent = gameData.narrative?.storyBeat || '未知';
                    document.getElementById('current-beat-operation').textContent = gameData.narrative?.storyBeatOperation || '未知';
                    document.getElementById('current-depth-level').textContent = gameData.narrative?.depthLevel || '未知';
                    document.getElementById('current-time').textContent = gameData.gameState?.currentTime || '未知';
                } catch (error) {
                    console.error('更新引擎工具标签页失败:', error);
                }
            }
            
            // 更新AI输入/输出标签页
            document.getElementById('aiInput').textContent = debugData.lastApiRequest || '无数据';
            document.getElementById('aiOutput').textContent = debugData.lastAiResponse || '无数据';
            
            // 更新阶段一标签页
            document.getElementById('phase1Input').textContent = debugData.phase1.input || '无数据';
            document.getElementById('phase1Output').textContent = debugData.phase1.output || '无数据';
            
            // 更新阶段二标签页
            document.getElementById('phase2Input').textContent = debugData.phase2.input || '无数据';
            document.getElementById('phase2Output').textContent = debugData.phase2.output || '无数据';
        }
    </script>
</body>
</html>