<!DOCTYPE html>
<html lang="zh-CN">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>擢升一瞥 - 游戏界面</title>
    <script src="src/js/dataManager.js"></script>
    <script src="src/js/responseParser.js"></script>
    <script src="src/js/engine.js"></script>
    <script src="src/js/storyStorage.js"></script>
    <script src="src/js/promptBuilder_storyteller.js"></script>
    <script src="src/js/contextCompressor.js"></script>
    <style>

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            background-color: white;
            color: #4CAF50;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            text-decoration: none;
        }
        
        .btn:hover {
            background-color: #f0f0f0;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .message {
            margin-bottom: 15px;
            max-width: 100%;
            word-wrap: break-word;
        }
        
        .message.user {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border-radius: 18px;
            align-self: flex-end;
            margin-left: auto;
            max-width: 80%;
        }
        
        .message.ai {
            color: #333;
            align-self: flex-start;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
        }
        
        #message-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            resize: none;
            outline: none;
        }
        
        #send-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #send-btn:hover {
            background-color: #45a049;
        }
        
        /* 调试悬浮窗样式 */
        .debug-panel {
            position: fixed;
            top: 80px;
            left: 20px;
            width: 400px;
            max-height: 500px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .debug-panel h3 {
            margin-top: 0;
            color: #4CAF50;
            font-size: 16px;
            border-bottom: 1px solid #555;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }
        
        .debug-section {
            margin-bottom: 15px;
        }
        
        .debug-section h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: #aaa;
        }
        
        .debug-content {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 10px;
            font-size: 12px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .debug-toggle {
            position: fixed;
            top: 80px;
            left: 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1001;
        }
        
        .debug-toggle:hover {
            background-color: #45a049;
        }
        
        /* 成就悬浮窗样式 */
        .achievements-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background-color: white;
            color: #333;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            z-index: 999;
            overflow-y: auto;
            display: none;
        }
        
        .achievements-panel h3 {
            margin-top: 0;
            color: #4CAF50;
            font-size: 18px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .achievement-item {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            border-left: 4px solid #4CAF50;
        }
        
        .achievement-item.completed {
            background-color: #e8f5e8;
            border-left-color: #4CAF50;
        }
        
        .achievement-item.hidden {
            background-color: #f5f5f5;
            border-left-color: #999;
        }
        
        .achievement-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .achievement-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .achievement-status {
            font-size: 12px;
            color: #888;
        }
        
        .achievements-toggle {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .achievements-toggle:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="btn">返回首页</a>
        <span>擢升一瞥</span>
        <div class="header-buttons">
            <button class="btn achievements-toggle" onclick="toggleAchievementsPanel()">成就</button>
            <a href="settings.html" class="btn">设置</a>
        </div>
    </div>
    
    <div class="chat-container">
        <div class="messages" id="messages">
            <div class="message ai">
                欢迎来到擢升一瞥的调试开发界面。我是你的AI助手，将会帮助你完成这个网页游戏的开发。
            </div>
        </div>
        
        <div class="input-area">
            <textarea id="message-input" placeholder="输入你的消息..." rows="1"></textarea>
            <button id="send-btn">➤</button>
        </div>
    </div>
    
    <!-- 调试悬浮窗 -->
    <button class="debug-toggle" onclick="toggleDebugPanel()">调试面板</button>
    <div class="debug-panel" id="debugPanel" style="display: none;">
        <h3>调试信息</h3>
        <div class="debug-section">
            <h4>最后一次AI回复</h4>
            <div class="debug-content" id="lastAiResponse">无数据</div>
        </div>
        <div class="debug-section">
            <h4>最后一次完整请求</h4>
            <div class="debug-content" id="lastApiRequest">无数据</div>
        </div>
        <div class="debug-section">
            <h4>data.json内容</h4>
            <div class="debug-content" id="dataJsonContent">加载中...</div>
        </div>
    </div>
    
    <!-- 成就悬浮窗 -->
    <div class="achievements-panel" id="achievementsPanel">
        <h3>成就列表</h3>
        <div class="achievements-content" id="achievementsContent">
            <div class="loading">加载成就中...</div>
        </div>
    </div>
    
    <script>
        // 全局调试属性
        const admin = true;
        // 防止修改
        Object.defineProperty(window, 'admin', {
            value: true,
            writable: false,
            configurable: false
        });
        
        // 聊天逻辑
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const debugPanel = document.getElementById('debugPanel');
        const lastAiResponse = document.getElementById('lastAiResponse');
        const lastApiRequest = document.getElementById('lastApiRequest');
        const dataJsonContent = document.getElementById('dataJsonContent');
        const debugToggle = document.querySelector('.debug-toggle');
        const achievementsPanel = document.getElementById('achievementsPanel');
        const achievementsContent = document.getElementById('achievementsContent');
        
        // 调试数据存储
        let debugData = {
            lastAiResponse: null,
            lastApiRequest: null,
            dataJson: null
        };
        
        // 页面加载时检查admin权限并隐藏调试按钮
        window.addEventListener('load', function() {
            if (typeof admin === 'undefined' || !admin) {
                debugToggle.style.display = 'none';
            } else {
                // 加载data.json内容
                loadDataJson();
            }
        });
        
        // 加载data.json内容
        async function loadDataJson() {
            try {
                const response = await fetch('data.json');
                if (response.ok) {
                    const data = await response.json();
                    debugData.dataJson = JSON.stringify(data, null, 2);
                    updateDebugPanel();
                } else {
                    throw new Error('加载失败');
                }
            } catch (error) {
                console.error('加载data.json失败:', error);
                debugData.dataJson = '加载失败: ' + error.message;
                updateDebugPanel();
            }
        }
        
        // 故事数据
        let fullStory = []; // 完整故事，不做删减
        let compressedStory = []; // 压缩故事（由摘要组成）
        let uncompressedStory = []; // 未压缩故事（实时故事）
        let latestUserMessage = null; // 最新用户消息
        
        // 检查API密钥状态并更新UI
        function checkApiKeyStatus() {
            // 从本地存储获取API密钥
            const savedSettings = localStorage.getItem('gameSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                if (settings.apiKey) {
                    // 有API密钥，启用控件
                    sendBtn.disabled = false;
                    messageInput.disabled = false;
                    return true;
                }
            }
            // 没有API密钥，禁用控件
            sendBtn.disabled = true;
            messageInput.disabled = true;
            return false;
        }

        // 初始化函数
        async function init() {
            // 检查是否是新游戏
            checkForNewGame();
            
            // 检查API密钥状态
            const hasApiKey = checkApiKeyStatus();
            if (!hasApiKey) {
                addMessage('请先在设置页面配置DeepSeek API密钥', false);
            }
            
            // 加载存储的故事数据
            loadStoryData();
            
            // 启动游戏引擎
            startEngine();
            
            // 加载成就数据
            await loadAchievementsData();
        }
        
        // 检查是否是新游戏
        function checkForNewGame() {
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const newGame = urlParams.get('newgame');
            
            if (newGame === 'true') {
                // 清空所有故事数据
                StoryStorage.clearAll();
                console.log('已清空所有故事数据，开始新游戏');
            }
        }
        
        // 加载故事数据
        function loadStoryData() {
            // 从StoryStorage加载数据
            const storyData = StoryStorage.loadAll();
            
            fullStory = storyData.fullStory || [];
            compressedStory = storyData.compressedStory || [];
            uncompressedStory = storyData.uncompressedStory || [];
            latestUserMessage = storyData.latestUserMessage;
            
            // 显示未压缩故事（实时故事）给玩家
            displayUncompressedStory();
        }
        
        // 显示未压缩故事（实时故事）给玩家
        function displayUncompressedStory() {
            if (uncompressedStory.length > 0) {
                // 清空现有消息
                messagesContainer.innerHTML = '';
                
                // 显示未压缩故事
                uncompressedStory.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.role === 'user' ? 'user' : 'ai'}`;
                    messageDiv.textContent = msg.content;
                    messagesContainer.appendChild(messageDiv);
                });
                
                // 滚动到底部
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                console.log('已显示未压缩故事，消息数:', uncompressedStory.length);
            }
        }
        
        // 启动游戏引擎
        async function startEngine() {
            console.log('开始启动游戏引擎');
            try {
                // 初始化游戏引擎
                const initResult = await GameEngineInstance.initialize();
                if (initResult.success) {
                    console.log('游戏引擎初始化成功:', initResult.message);
                    // 获取引擎状态
                    const status = GameEngineInstance.getStatus();
                    console.log('游戏引擎状态:', status);
                } else {
                    console.error('游戏引擎初始化失败:', initResult.error);
                }
            } catch (error) {
                console.error('启动游戏引擎错误:', error);
            }
        }
        
        // 添加消息到聊天界面
        async function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            messageDiv.textContent = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // 计算消息字数
            const messageWordCount = content.length;
            
            // 创建未压缩故事的消息对象（包含时间戳）
            const uncompressedMessageObj = { 
                role: isUser ? 'user' : 'assistant', 
                content: content,
                timestamp: new Date().toISOString(),
                wordCount: messageWordCount
            };
            
            // 创建完整故事的消息对象（不包含时间戳）
            const fullMessageObj = { 
                role: isUser ? 'user' : 'assistant', 
                content: content
            };
            
            // 更新未压缩故事（实时故事）- 包含时间戳
            uncompressedStory.push(uncompressedMessageObj);
            
            // 更新完整故事 - 不包含时间戳
            fullStory.push(fullMessageObj);
            
            // 如果是用户消息，更新最新用户消息
            if (isUser) {
                latestUserMessage = uncompressedMessageObj;
            }
            
            // 更新字数统计
            if (!isUser) { // 只统计AI的故事内容
                try {
                    // 获取当前游戏数据
                    const gameData = GameEngineInstance.getGameData();
                    
                    // 计算当前节拍
                    const currentBeat = gameData.narrative?.storyBeat || '起';
                    
                    // 更新当前节拍的字数
                    if (gameData.narrative?.beatStats?.current) {
                        gameData.narrative.beatStats.current[currentBeat] = 
                            (gameData.narrative.beatStats.current[currentBeat] || 0) + messageWordCount;
                    }
                    
                    // 更新当前循环字数
                    gameData.narrative.currentCycleWords = 
                        (gameData.narrative.currentCycleWords || 0) + messageWordCount;
                    
                    // 更新总字数
                    gameData.narrative.totalWords = 
                        (gameData.narrative.totalWords || 0) + messageWordCount;
                    
                    // 保存更新后的数据
                    await GameEngineInstance.saveGameData();
                    
                    console.log(`字数统计更新：当前节拍[${currentBeat}]增加${messageWordCount}字，总字数${gameData.narrative.totalWords}`);
                } catch (error) {
                    console.error('更新字数统计失败:', error);
                }
            }
            
            // 检查是否需要压缩上下文
            if (ContextCompressor.shouldCompress(uncompressedStory)) {
                console.log('检测到未压缩消息数达到阈值，准备进行压缩');
                
                // 从本地存储获取API密钥
                const savedSettings = localStorage.getItem('gameSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    const apiKey = settings.apiKey;
                    
                    if (apiKey) {
                        try {
                            // 压缩最早的8条消息
                            const messagesToCompress = uncompressedStory.slice(0, 8);
                            const compressedMessage = await ContextCompressor.compressContext(messagesToCompress, apiKey);
                            if (compressedMessage) {
                                // 更新压缩故事
                                compressedStory.push(compressedMessage);
                                
                                // 保留最后4条未压缩消息作为叙事风格稳定器
                                uncompressedStory = uncompressedStory.slice(8);
                                
                                console.log('上下文压缩完成，压缩故事数:', compressedStory.length, '保留的未压缩故事数:', uncompressedStory.length);
                            }
                        } catch (error) {
                            console.error('压缩上下文失败:', error);
                        }
                    }
                }
            }
            
            // 保存所有故事数据
            saveStoryData();
            
            // 输出故事数据状态
            console.log('故事数据状态：完整故事长度:', fullStory.length, '压缩故事长度:', compressedStory.length, '未压缩故事长度:', uncompressedStory.length);
        }
        
        // 保存故事数据
        function saveStoryData() {
            StoryStorage.saveAll(fullStory, compressedStory, uncompressedStory, latestUserMessage);
        }
        
        // 发送消息
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                // 添加用户消息
                await addMessage(message, true);
                messageInput.value = '';
                
                // 禁用发送按钮和输入框，防止重复发送
                sendBtn.disabled = true;
                sendBtn.textContent = '...';
                messageInput.disabled = true;
                
                try {
                    // 调用DeepSeek API获取回复
                    const aiResponse = await callDeepSeekAPI(message);
                    
                    // 使用游戏引擎处理AI响应
                    const processResult = await GameEngineInstance.processAIResponse(aiResponse);
                    
                    // 添加处理后的故事到聊天界面
                    await addMessage(processResult.story);
                } catch (error) {
                    console.error('调用DeepSeek API失败:', error);
                    await addMessage('抱歉，AI回复失败，请稍后重试。', false);
                } finally {
                    // 恢复发送按钮和输入框
                    sendBtn.disabled = false;
                    sendBtn.textContent = '➤';
                    messageInput.disabled = false;
                }
            }
        }
        
        // 调用DeepSeek API
        async function callDeepSeekAPI(userMessage) {
            // 从本地存储获取API密钥
            const savedSettings = localStorage.getItem('gameSettings');
            if (!savedSettings) {
                throw new Error('请先在设置页面配置DeepSeek API密钥');
            }
            
            const settings = JSON.parse(savedSettings);
            const apiKey = settings.apiKey;
            
            if (!apiKey) {
                throw new Error('请先在设置页面配置DeepSeek API密钥');
            }
            
            // 使用PromptBuilder准备请求数据并发送API请求
            const { requestData, apiKey: finalApiKey } = await PromptBuilder.prepareRequestData(
                apiKey, 
                userMessage, 
                compressedStory, 
                uncompressedStory, 
                latestUserMessage
            );
            
            // 存储完整请求数据到调试数据
            debugData.lastApiRequest = JSON.stringify(requestData, null, 2);
            updateDebugPanel();
            
            const response = await PromptBuilder.sendApiRequest(requestData, finalApiKey);
            
            // 存储最后一次AI回复到调试数据
            debugData.lastAiResponse = response;
            updateDebugPanel();
            
            return response;
        }
        
        // 切换调试面板显示/隐藏
        function toggleDebugPanel() {
            if (debugPanel.style.display === 'none') {
                debugPanel.style.display = 'block';
            } else {
                debugPanel.style.display = 'none';
            }
        }
        
        // 更新调试面板内容
        function updateDebugPanel() {
            if (debugData.lastAiResponse) {
                lastAiResponse.textContent = debugData.lastAiResponse;
            } else {
                lastAiResponse.textContent = '无数据';
            }
            
            if (debugData.lastApiRequest) {
                lastApiRequest.textContent = debugData.lastApiRequest;
            } else {
                lastApiRequest.textContent = '无数据';
            }
            
            if (debugData.dataJson) {
                dataJsonContent.textContent = debugData.dataJson;
            } else {
                dataJsonContent.textContent = '加载中...';
            }
        }
        
        // 事件监听
        sendBtn.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // 自动调整输入框高度
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
        });
        
        // 页面加载完成后初始化
        window.addEventListener('load', init);
        
        // 当页面获得焦点时，重新检查API密钥状态
        window.addEventListener('focus', function() {
            const hasApiKey = checkApiKeyStatus();
            if (hasApiKey) {
                // 如果之前没有API密钥，现在有了，显示提示消息
                console.log('API密钥已配置，控件已启用');
            }
        });
        
        // 切换成就面板显示/隐藏
        function toggleAchievementsPanel() {
            if (achievementsPanel.style.display === 'none' || achievementsPanel.style.display === '') {
                achievementsPanel.style.display = 'block';
                // 每次打开时重新加载成就数据
                loadAchievementsData();
            } else {
                achievementsPanel.style.display = 'none';
            }
        }
        
        // 加载成就数据
        async function loadAchievementsData() {
            try {
                // 从游戏引擎获取成就数据
                const achievementsData = GameEngineInstance.getAchievementsData();
                if (achievementsData && achievementsData.achievements) {
                    displayAchievements(achievementsData.achievements);
                } else {
                    // 如果游戏引擎未初始化，尝试直接从文件加载
                    const response = await fetch('src/data/achievements.json');
                    if (response.ok) {
                        const data = await response.json();
                        displayAchievements(data.achievements);
                    } else {
                        throw new Error('加载成就数据失败');
                    }
                }
            } catch (error) {
                console.error('加载成就数据错误:', error);
                achievementsContent.innerHTML = '<div class="error">加载成就失败</div>';
            }
        }
        
        // 显示成就列表
        function displayAchievements(achievements) {
            if (!achievements || achievements.length === 0) {
                achievementsContent.innerHTML = '<div class="no-achievements">暂无成就</div>';
                return;
            }
            
            // 过滤出可见的成就
            const visibleAchievements = achievements.filter(achievement => !achievement.isHidden);
            
            if (visibleAchievements.length === 0) {
                achievementsContent.innerHTML = '<div class="no-achievements">暂无可见成就</div>';
                return;
            }
            
            // 按完成状态排序
            visibleAchievements.sort((a, b) => {
                if (a.isCompleted && !b.isCompleted) return -1;
                if (!a.isCompleted && b.isCompleted) return 1;
                return 0;
            });
            
            let html = '';
            
            visibleAchievements.forEach(achievement => {
                const className = `achievement-item ${achievement.isCompleted ? 'completed' : ''} ${achievement.isHidden ? 'hidden' : ''}`;
                const statusText = achievement.isCompleted ? '已完成' : '未完成';
                
                html += `
                    <div class="${className}">
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-description">${achievement.description}</div>
                        <div class="achievement-status">状态: ${statusText}</div>
                    </div>
                `;
            });
            
            achievementsContent.innerHTML = html;
        }
    </script>
</body>
</html>