<!DOCTYPE html>
<html lang="zh-CN">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>擢升一瞥 - 游戏界面</title>
    <script src="src/js/configLoader.js"></script>
    <script src="src/js/utils.js"></script>
    <script src="src/js/dataManager.js"></script>
    <script src="src/js/responseParser.js"></script>
    <script src="src/js/engine.js"></script>
    <script src="src/js/storyStorage.js"></script>
    <script src="src/js/promptManager.js"></script>
    <script src="src/js/providerConfig.js"></script>
    <script src="src/js/promptBuilder_storyteller.js"></script>
    <script src="src/js/promptBuilder_recorder.js"></script>
    <script src="src/js/contextCompressor.js"></script>
    <script src="src/js/debugPanel.js"></script>
    <style>
        /* 动态颜色变量 */
        :root {
            --primary-color: #1a2e3c;
            --secondary1-color: #121c24;
            --secondary2-color: #1e2d3a;
            --secondary3-color: #2a3f4c;
            --accent-color: #cc5522;
            --neutral1-color: #f5f5f5;
            --neutral2-color: #e0e0e0;
            --neutral3-color: #b0b0b0;
            --neutral4-color: #808080;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: var(--secondary1-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: var(--neutral1-color);
        }
        
        .header {
            background-color: var(--secondary1-color);
            color: var(--neutral1-color);
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-bar {
            background-color: var(--secondary2-color);
            color: var(--neutral3-color);
            padding: 5px 15px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--secondary3-color);
            position: relative;
        }
        
        /* 版本号样式 */
        .version-info {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            font-size: 12px;
            color: var(--neutral3-color);
            background-color: var(--secondary2-color);
            padding: 4px 8px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }
        
        .story-stats {
            display: flex;
            gap: 15px;
        }
        
        .current-time {
            text-align: right;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            background-color: var(--secondary3-color);
            color: var(--neutral1-color);
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            text-decoration: none;
        }
        
        .btn:hover {
            background-color: #3a4f5c;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--secondary2-color);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .message {
            margin-bottom: 15px;
            max-width: 100%;
            word-wrap: break-word;
        }
        
        .message.user {
            background-color: var(--secondary3-color);
            color: var(--neutral1-color);
            padding: 10px 15px;
            border-radius: 18px;
            align-self: flex-end;
            margin-left: auto;
            width: fit-content;
            text-align: right;
            max-width: 80%;
        }
        
        .message.ai {
            color: var(--neutral2-color);
            align-self: flex-start;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .input-area {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            width: 100%;
            min-width: 0;
            box-sizing: border-box;
        }

        .input-area > div {
            flex: 1;
            min-width: 0;
            position: relative;
        }

        #message-input {
            width: 100%;
            min-width: 0;
            min-height: 40px;
            max-height: 120px;
            padding: 12px 40px 12px 15px;
            border: 1px solid var(--secondary3-color);
            border-radius: 25px;
            font-size: 16px;
            resize: none;
            outline: none;
            background-color: var(--secondary2-color);
            color: var(--neutral1-color);
            box-sizing: border-box;
        }

        #char-count {
            position: absolute;
            bottom: 8px;
            right: 10px;
            font-size: 12px;
            color: var(--neutral4-color);
        }

        #send-btn {
            background-color: var(--primary-color);
            color: var(--neutral1-color);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }

        #send-btn:hover {
            background-color: var(--secondary3-color);
        }

        #send-btn:disabled {
            background-color: var(--neutral4-color);
            cursor: not-allowed;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            /* 手机模式 */
            .chat-container {
                padding: 10px;
            }
            
            .input-area {
                gap: 8px;
                width: 100%;
            }
            
            .input-area > div {
                flex: 1;
            }
            
            #message-input {
                width: 100%;
                padding: 10px;
                font-size: 14px;
                border-radius: 20px;
            }
            
            #send-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .messages {
                padding: 10px;
                margin-bottom: 10px;
            }
        }

        @media (min-width: 769px) {
            /* 电脑模式 */
            .input-area {
                gap: 12px;
                width: 100%;
            }
            
            .input-area > div {
                flex: 1;
            }
            
            #message-input {
                width: 100%;
                padding: 14px;
                font-size: 16px;
                border-radius: 25px;
            }
            
            #send-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
        
        .achievement-btn {
            margin-top: 8px;
            padding: 6px 12px;
            background-color: var(--primary-color);
            color: var(--neutral1-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }
        
        .achievement-btn:hover {
            background-color: var(--secondary3-color);
        }
        
        /* 错误提示盒样式 */
        .error-box {
            background-color: var(--secondary2-color);
            border-left: 4px solid var(--accent-color);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .error-box h4 {
            color: var(--neutral1-color);
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .error-box p {
            color: var(--neutral3-color);
            margin: 5px 0;
            line-height: 1.4;
        }
        
        .error-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .error-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            color: var(--neutral1-color);
        }
        
        .error-button.settings {
            background-color: var(--secondary3-color);
        }
        
        .error-button.retry {
            background-color: var(--accent-color);
            color: var(--neutral1-color);
            flex: 1;
        }
        
        .error-button.cancel {
            background-color: var(--neutral4-color);
        }
        
        .error-button:hover {
            opacity: 0.8;
        }
        
        /* 调试抽屉样式 */
        .debug-toggle {
            position: fixed;
            top: 33.33%;
            right: 0;
            width: 30px;
            height: 120px;
            background-color: var(--accent-color);
            color: var(--neutral1-color);
            border: none;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .debug-toggle:hover {
            background-color: var(--accent-color);
            opacity: 0.8;
            width: 40px;
        }
        
        /* 调试面板展开时，调试按钮左移 */
        .debug-panel.open ~ .debug-toggle {
            right: 320px;
        }
        
        /* 移动端调试面板展开时，隐藏调试按钮 */
        @media (max-width: 768px) {
            .debug-panel.open ~ .debug-toggle {
                display: none;
            }
        }
        
        .debug-panel {
            position: fixed;
            top: 0;
            right: -340px;
            width: 320px;
            height: 100vh;
            background-color: var(--secondary2-color);
            color: var(--neutral1-color);
            border-radius: 10px 0 0 10px;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.4);
            z-index: 999;
            overflow: hidden;
            transition: right 0.3s ease;
        }
        
        .debug-panel.open {
            right: 0;
        }
        
        .debug-panel-header {
            padding: 15px;
            border-bottom: 1px solid var(--secondary3-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .debug-panel h3 {
            margin: 0;
            color: var(--neutral1-color);
            font-size: 14px;
        }
        
        .debug-close-btn {
            background: none;
            border: none;
            color: var(--accent-color);
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .debug-close-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* 选项卡样式 */
        .debug-tabs {
            display: flex;
            margin: 0 10px;
            border-bottom: 1px solid var(--secondary3-color);
            flex-wrap: wrap;
        }
        
        .debug-tab {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 11px;
            color: var(--neutral1-color);
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }
        
        .debug-tab.active {
            color: var(--neutral1-color);
            border-bottom-color: var(--accent-color);
        }
        
        .debug-tab-content {
            padding: 15px;
            height: calc(100vh - 120px);
            overflow-y: auto;
        }
        
        .debug-section {
            margin-bottom: 12px;
        }
        
        .debug-section h4 {
            margin: 0 0 5px 0;
            font-size: 12px;
            color: var(--neutral1-color);
        }
        
        .debug-content {
            background-color: var(--secondary3-color);
            border-radius: 5px;
            padding: 8px;
            font-size: 11px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
            color: var(--neutral1-color);
        }
        
        /* 引擎工具按钮样式 */
        .engine-tool-btn {
            background-color: var(--secondary1-color);
            color: var(--neutral1-color);
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            transition: background-color 0.3s;
        }
        
        .engine-tool-btn:hover {
            background-color: var(--secondary3-color);
        }
        
        .engine-tool-btn:disabled {
            background-color: var(--secondary3-color);
            cursor: not-allowed;
        }
        
        /* 游戏数据显示样式 */
        .game-data-display {
            font-size: 11px;
            line-height: 1.4;
            color: var(--neutral1-color);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .debug-panel {
                width: 280px;
                right: -300px;
            }
            
            .debug-toggle {
                width: 50px;
                height: 80px;
                font-size: 10px;
            }
            
            .debug-toggle:hover {
                width: 60px;
            }
            
            .debug-tab {
                font-size: 10px;
                padding: 5px 10px;
            }
            
            .debug-tab-content {
                padding: 10px;
                height: calc(100vh - 110px);
            }
        }
        
        @media (max-width: 480px) {
            .debug-panel {
                width: 260px;
                right: -280px;
            }
            
            .debug-toggle {
                width: 40px;
                height: 70px;
                font-size: 9px;
            }
            
            .debug-toggle:hover {
                width: 50px;
            }
            
            .debug-tab {
                padding: 4px 8px;
                font-size: 9px;
            }
            
            .debug-tab-content {
                font-size: 10px;
                padding: 8px;
                height: calc(100vh - 100px);
            }
        }
        
        .debug-toggle:hover {
            background-color: var(--accent-color);
            opacity: 0.8;
        }
        
        /* 成就悬浮窗样式 */
        .achievements-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background-color: var(--secondary2-color);
            color: var(--neutral1-color);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
            z-index: 999;
            overflow-y: auto;
            display: none;
        }
        
        .achievements-panel h3 {
            margin-top: 0;
            color: var(--neutral1-color);
            font-size: 18px;
            border-bottom: 1px solid var(--secondary3-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .achievement-item {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: var(--secondary1-color);
            border-left: 4px solid var(--primary-color);
        }
        
        .achievement-item.completed {
            background-color: var(--secondary2-color);
            border-left-color: var(--primary-color);
        }
        
        .achievement-item.hidden {
            background-color: var(--secondary1-color);
            border-left-color: var(--neutral4-color);
        }
        
        .achievement-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--neutral1-color);
        }
        
        .achievement-description {
            font-size: 14px;
            color: var(--neutral3-color);
            margin-bottom: 5px;
        }
        
        /* 加载等待条样式 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 70px;
            background-color: rgba(26, 46, 60, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: var(--neutral1-color);
            font-size: 18px;
            flex-direction: row;
            gap: 15px;
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--neutral1-color);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 14px;
            color: var(--neutral1-color);
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="btn">返回首页</a>
        <span>擢升一瞥</span>
        <div class="header-buttons">
            <button class="btn achievements-toggle" onclick="toggleAchievementsPanel()">成就</button>
            <a href="settings.html" class="btn">设置</a>
        </div>
    </div>
    <div class="status-bar">
        <div class="story-stats" id="story-stats">
            <span id="full-story-words">字数统计：0字</span>
        </div>
        <div class="current-time" id="current-time-display">加载中...</div>
    </div>
    
    <div class="chat-container">
        <div class="messages" id="messages">
            <div class="message ai">
                在雾中……有一座城。
            </div>
        </div>
        
        <div class="input-area">
            <div style="position: relative; flex: 1;">
                <textarea id="message-input" placeholder="输入你的消息..." rows="1" maxlength="500"></textarea>
                <div style="position: absolute; bottom: 10px; right: 10px; font-size: 12px; color: #999;" id="char-count">0/500</div>
            </div>
            <button id="send-btn">➤</button>
        </div>
    </div>
    
    <!-- 调试抽屉 -->
    <div class="debug-panel" id="debugPanel">
        <div class="debug-panel-header">
            <h3>调试信息</h3>
            <button class="debug-close-btn" onclick="toggleDebugPanel()">×</button>
        </div>
        <div class="debug-tabs">
            <div class="debug-tab" onclick="switchDebugTab('engine-tools')">引擎工具</div>
            <div class="debug-tab active" onclick="switchDebugTab('ai-data')">AI输入/输出</div>
            <div class="debug-tab" onclick="switchDebugTab('phase1')">阶段一 (故事讲述者)</div>
            <div class="debug-tab" onclick="switchDebugTab('phase2')">阶段二 (故事记录者)</div>
            <div class="debug-tab" onclick="switchDebugTab('compressed-story')">压缩故事</div>
            <div class="debug-tab" onclick="switchDebugTab('game-data')">游戏数据</div>
        </div>
        <div class="debug-tab-content" id="engine-tools-tab" style="display: none;">
            <div class="debug-section">
                <h4>节拍操作</h4>
                <div class="game-data-display" id="beat-data-display" style="margin-bottom: 10px; padding: 8px; background-color: rgba(255, 255, 255, 0.1); border-radius: 4px;">
                    当前节拍：<span id="current-beat">加载中...</span><br>
                    节拍操作：<span id="current-beat-operation">加载中...</span>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                    <button class="engine-tool-btn" onclick="executeEngineTool('update', 'narrative.storyBeatOperation', '推进')">推进</button>
                    <button class="engine-tool-btn" onclick="executeEngineTool('update', 'narrative.storyBeatOperation', '维持')">维持</button>
                    <button class="engine-tool-btn" onclick="executeEngineTool('update', 'narrative.storyBeatOperation', '完结')">完结</button>
                </div>
            </div>
            
            <div class="debug-section">
                <h4>字数统计</h4>
                <div class="game-data-display" id="word-counts-display" style="margin-bottom: 10px; padding: 8px; background-color: rgba(255, 255, 255, 0.1); border-radius: 4px;">
                    完整故事：<span id="debug-full-story-words">0字</span><br>
                    压缩故事：<span id="debug-compressed-story-words">0字</span><br>
                    未压缩故事：<span id="debug-uncompressed-story-words">0字</span>
                </div>
            </div>
            <div class="debug-section">
                <h4>景深等级</h4>
                <div class="game-data-display" id="depth-data-display" style="margin-bottom: 10px; padding: 8px; background-color: rgba(255, 255, 255, 0.1); border-radius: 4px;">
                    当前景深等级：<span id="current-depth-level">加载中...</span>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                    <button class="engine-tool-btn" onclick="executeEngineTool('update', 'narrative.depthLevel', '1')">景深 1</button>
                    <button class="engine-tool-btn" onclick="executeEngineTool('update', 'narrative.depthLevel', '2')">景深 2</button>
                    <button class="engine-tool-btn" onclick="executeEngineTool('update', 'narrative.depthLevel', '3')">景深 3</button>
                    <button class="engine-tool-btn" onclick="executeEngineTool('update', 'narrative.depthLevel', '4')">景深 4</button>
                    <button class="engine-tool-btn" onclick="executeEngineTool('update', 'narrative.depthLevel', '5')">景深 5</button>
                </div>
            </div>
            <div class="debug-section">
                <h4>时间设置</h4>
                <div class="game-data-display" id="time-data-display" style="margin-bottom: 10px; padding: 8px; background-color: rgba(255, 255, 255, 0.1); border-radius: 4px;">
                    当前时间：<span id="current-time">加载中...</span>
                </div>
                <div style="margin-bottom: 10px;">
                    <input type="datetime-local" id="time-input" style="width: 100%; padding: 8px; margin-bottom: 8px;" />
                    <button class="engine-tool-btn" onclick="executeTimeTool()">设置时间</button>
                </div>
            </div>
            <div class="debug-section">
                <h4>事件操作</h4>
                <button class="engine-tool-btn" onclick="toggleEventForm()">注册/更新事件</button>
                <div id="event-form" style="display: none; margin-top: 10px; padding: 10px; background-color: rgba(255, 255, 255, 0.1); border-radius: 5px;">
                    <input type="text" id="event-name" placeholder="事件名称" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <textarea id="event-description" placeholder="事件描述" rows="2" style="width: 100%; padding: 6px; margin-bottom: 6px;" ></textarea>
                    <div style="margin-bottom: 4px; font-size: 12px; color: #999;">开始时间（默认：游戏当前时间）</div>
                    <input type="datetime-local" id="event-start-time" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <div style="margin-bottom: 4px; font-size: 12px; color: #999;">结束时间（默认：开始时间后1小时）</div>
                    <input type="datetime-local" id="event-end-time" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <input type="number" id="event-importance" placeholder="重要程度 (1-5)" min="1" max="5" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <button class="engine-tool-btn" onclick="executeEventTool('registerEvent')">注册事件</button>
                </div>
                <div style="margin-top: 10px;">
                    <input type="text" id="delete-event-name" placeholder="事件名称" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <button class="engine-tool-btn" onclick="executeEngineTool('deleteEvent', null, document.getElementById('delete-event-name').value)">删除事件</button>
                </div>
            </div>
            <div class="debug-section">
                <h4>成就操作</h4>
                <input type="text" id="achievement-name" placeholder="成就名称" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                <div style="display: flex; gap: 8px;">
                    <button class="engine-tool-btn" onclick="executeEngineTool('completeAchievement', null, document.getElementById('achievement-name').value)">完成成就</button>
                    <button class="engine-tool-btn" onclick="executeEngineTool('showAchievement', null, document.getElementById('achievement-name').value)">显示成就</button>
                </div>
            </div>
            <div class="debug-section">
                <h4>伏笔操作</h4>
                <button class="engine-tool-btn" onclick="toggleForeshadowingForm()">添加/更新伏笔</button>
                <div id="foreshadowing-form" style="display: none; margin-top: 10px; padding: 10px; background-color: rgba(255, 255, 255, 0.1); border-radius: 5px;">
                    <input type="text" id="foreshadowing-name" placeholder="伏笔名称" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <textarea id="foreshadowing-description" placeholder="伏笔描述" rows="2" style="width: 100%; padding: 6px; margin-bottom: 6px;" ></textarea>
                    <div style="margin-bottom: 4px; font-size: 12px; color: #999;">发生时间（默认：游戏当前时间）</div>
                    <input type="datetime-local" id="foreshadowing-time" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <input type="number" id="foreshadowing-importance" placeholder="重要程度 (1-5)" min="1" max="5" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <button class="engine-tool-btn" onclick="executeForeshadowingTool('addForeshadowing')">添加伏笔</button>
                </div>
                <div style="margin-top: 10px;">
                    <input type="text" id="delete-foreshadowing-name" placeholder="伏笔名称" style="width: 100%; padding: 6px; margin-bottom: 6px;" />
                    <button class="engine-tool-btn" onclick="executeEngineTool('removeForeshadowing', null, document.getElementById('delete-foreshadowing-name').value)">删除伏笔</button>
                </div>
            </div>
        </div>
        <div class="debug-tab-content" id="ai-data-tab">
            <div class="debug-section">
                <h4>AI输入/输出</h4>
                <div class="debug-section">
                    <h5>输入 (发送给AI)</h5>
                    <div class="debug-content" id="aiInput">无数据</div>
                </div>
                <div class="debug-section">
                    <h5>输出 (AI回复)</h5>
                    <div class="debug-content" id="aiOutput">无数据</div>
                </div>
                <div class="debug-section">
                    <h5>两阶段模式 - 阶段一 (故事讲述者)</h5>
                    <div class="debug-section">
                        <h6>输入</h6>
                        <div class="debug-content" id="phase1Input-ai">无数据</div>
                    </div>
                    <div class="debug-section">
                        <h6>输出</h6>
                        <div class="debug-content" id="phase1Output-ai">无数据</div>
                    </div>
                </div>
                <div class="debug-section">
                    <h5>两阶段模式 - 阶段二 (故事记录者)</h5>
                    <div class="debug-section">
                        <h6>输入</h6>
                        <div class="debug-content" id="phase2Input-ai">无数据</div>
                    </div>
                    <div class="debug-section">
                        <h6>输出</h6>
                        <div class="debug-content" id="phase2Output-ai">无数据</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="debug-tab-content" id="phase1-tab" style="display: none;">
            <div class="debug-section">
                <h4>阶段一 - 故事讲述者</h4>
                <div class="debug-section">
                    <h5>输入 (发送给AI)</h5>
                    <div class="debug-content" id="phase1Input">无数据</div>
                </div>
                <div class="debug-section">
                    <h5>输出 (AI回复)</h5>
                    <div class="debug-content" id="phase1Output">无数据</div>
                </div>
            </div>
        </div>
        <div class="debug-tab-content" id="phase2-tab" style="display: none;">
            <div class="debug-section">
                <h4>阶段二 - 故事记录者</h4>
                <div class="debug-section">
                    <h5>输入 (发送给AI)</h5>
                    <div class="debug-content" id="phase2Input">无数据</div>
                </div>
                <div class="debug-section">
                    <h5>输出 (AI回复)</h5>
                    <div class="debug-content" id="phase2Output">无数据</div>
                </div>
            </div>
        </div>
        <div class="debug-tab-content" id="compressed-story-tab" style="display: none;">
            <div class="debug-section">
                <h4>压缩后的故事</h4>
                <div class="debug-data" id="compressed-story-content">
                    加载中...
                </div>
            </div>
        </div>
        <div class="debug-tab-content" id="game-data-tab" style="display: none;">
            <div class="debug-section">
                <h4>data.json内容</h4>
                <div class="debug-content" id="dataJsonContent">加载中...</div>
            </div>
        </div>
    </div>
    <button class="debug-toggle" id="debugToggle" onclick="toggleDebugPanel()" style="display: none;">调试</button>
    
    <!-- 成就悬浮窗 -->
    <div class="achievements-panel" id="achievementsPanel">
        <h3>成就列表</h3>
        <div class="achievements-content" id="achievementsContent">
            <div class="loading">加载成就中...</div>
        </div>
    </div>
    
    <!-- 加载等待条 -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">世界加载中...</div>
    </div>
    
    <!-- 版本号显示 -->
    <div class="version-info">版本 <span id="version-number">加载中...</span></div>
    
    <script>
        // 加载并同步版本号
        async function loadVersion() {
            try {
                const response = await fetch('package.json');
                if (response.ok) {
                    const packageData = await response.json();
                    const versionElement = document.getElementById('version-number');
                    if (versionElement) {
                        versionElement.textContent = packageData.version;
                    }
                }
            } catch (error) {
                console.error('加载版本信息失败:', error);
            }
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', function() {
            loadVersion();
        });
    </script>
    <script>
        // 全局调试属性
        let admin; // 初始值会在加载配置后更新
        
        // 加载配置
        async function initConfig() {
            const config = await configLoader.load();
            // 使用更严格的检查方式，确保false值被正确处理
            admin = config.admin !== undefined ? config.admin : true;
            
            // 定义全局admin属性
            Object.defineProperty(window, 'admin', {
                value: admin,
                writable: true,
                configurable: true
            });
            
            // 根据admin状态控制调试按钮的显示/隐藏
            const debugToggle = document.getElementById('debugToggle');
            if (debugToggle) {
                debugToggle.style.display = admin ? 'block' : 'none';
            }
            
            // 调试面板通过CSS类'open'控制滑入滑出，不要修改display属性
            // 只在admin为true时初始化DebugPanelInstance
            if (admin && typeof DebugPanel !== 'undefined' && !window.DebugPanelInstance) {
                window.DebugPanelInstance = new DebugPanel();
            }
            
            console.log('配置加载完成:', config);
            console.log('admin状态:', admin);
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', async function() {
            await initConfig();
            loadVersion();
            // 加载data.json内容
            if (admin) {
                loadDataJson();
            }
        });
        
        // 显示加载等待条
        function showLoading(text = '世界加载中...') {
            console.log('调用showLoading函数，文本:', text);
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            console.log('加载条元素:', overlay);
            console.log('加载条文本元素:', loadingText);
            if (overlay && loadingText) {
                loadingText.textContent = text;
                overlay.style.display = 'flex';
                console.log('加载条显示成功');
            } else {
                console.error('加载条元素未找到');
            }
        }
        
        // 隐藏加载等待条
        function hideLoading() {
            console.log('调用hideLoading函数');
            const overlay = document.getElementById('loadingOverlay');
            console.log('加载条元素:', overlay);
            if (overlay) {
                overlay.style.display = 'none';
                console.log('加载条隐藏成功');
            } else {
                console.error('加载条元素未找到');
            }
        }
        
        // 调试数据存储
        let debugData = {
            phase1: {
                input: null,
                output: null
            },
            phase2: {
                input: null,
                output: null
            },
            lastAiResponse: null,
            lastApiRequest: null,
            dataJson: null
        };
        
        // 页面加载时检查admin权限
        // 注意：此代码已移至上面的initConfig函数中
        
        // 加载data.json内容
        async function loadDataJson() {
            try {
                // 首先尝试从localStorage加载数据（游戏引擎实际存储的位置）
                const localStorageData = localStorage.getItem('gameData');
                if (localStorageData) {
                    const data = JSON.parse(localStorageData);
                    debugData.dataJson = JSON.stringify(data, null, 2);
                    if (window.DebugPanelInstance) {
                        window.DebugPanelInstance.updateContent();
                    }
                    return;
                }
                
                // 如果localStorage中没有数据，尝试从文件加载（备用方案）
                const response = await fetch('src/data/data.json');
                if (response.ok) {
                    const data = await response.json();
                    debugData.dataJson = JSON.stringify(data, null, 2);
                    if (window.DebugPanelInstance) {
                        window.DebugPanelInstance.updateContent();
                    }
                } else {
                    throw new Error('加载失败');
                }
            } catch (error) {
                console.error('加载游戏数据失败:', error);
                debugData.dataJson = '加载失败: ' + error.message;
                if (window.DebugPanelInstance) {
                    window.DebugPanelInstance.updateContent();
                }
            }
        }
        
        // 故事数据
        let fullStory = []; // 完整故事，不做删减
        let compressedStory = []; // 压缩故事（由摘要组成）
        let uncompressedStory = []; // 未压缩故事（实时故事）
        let latestUserMessage = null; // 最新用户消息
        
        // 计算故事字数
        function calculateStoryWords(story) {
            if (!story || !Array.isArray(story)) {
                return 0;
            }
            return story.reduce((total, msg) => {
                if (msg && msg.content) {
                    return total + msg.content.length;
                }
                return total;
            }, 0);
        }
        
        // 更新故事字数统计
        function updateStoryWordCounts() {
            const fullStoryWords = calculateStoryWords(fullStory);
            const compressedStoryWords = calculateStoryWords(compressedStory);
            const uncompressedStoryWords = calculateStoryWords(uncompressedStory);
            
            // 根据admin模式状态显示不同的字数统计
            if (typeof admin === 'undefined' || !admin) {
                // 非admin模式：只显示字数统计（完整故事）
                const fullStoryElement = document.getElementById('full-story-words');
                if (fullStoryElement) {
                    fullStoryElement.textContent = `字数统计：${fullStoryWords}字`;
                }
            } else {
                // admin模式：在调试抽屉中显示所有字数统计
                const debugFullStoryElement = document.getElementById('debug-full-story-words');
                const debugCompressedStoryElement = document.getElementById('debug-compressed-story-words');
                const debugUncompressedStoryElement = document.getElementById('debug-uncompressed-story-words');
                
                if (debugFullStoryElement) {
                    debugFullStoryElement.textContent = `${fullStoryWords}字`;
                }
                if (debugCompressedStoryElement) {
                    debugCompressedStoryElement.textContent = `${compressedStoryWords}字`;
                }
                if (debugUncompressedStoryElement) {
                    debugUncompressedStoryElement.textContent = `${uncompressedStoryWords}字`;
                }
                
                // 隐藏状态栏中的字数统计
                const storyStatsElement = document.getElementById('story-stats');
                if (storyStatsElement) {
                    storyStatsElement.style.display = 'none';
                }
            }
        }
        
        // 更新当前时间显示（显示故事中的时间）
        function updateCurrentTime() {
            try {
                // 从游戏引擎获取故事时间
                if (GameEngineInstance) {
                    const gameData = GameEngineInstance.getGameData();
                    const storyTime = gameData.gameState?.currentTime || gameData.metadata?.currentTime;
                    
                    if (storyTime) {
                        document.getElementById('current-time-display').textContent = storyTime;
                        return;
                    }
                }
                
                // 如果无法获取故事时间，显示系统时间作为备用
                const now = new Date();
                const timeString = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                document.getElementById('current-time-display').textContent = timeString;
            } catch (error) {
                console.error('更新故事时间失败:', error);
                // 出错时显示系统时间
                const now = new Date();
                const timeString = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                document.getElementById('current-time-display').textContent = timeString;
            }
        }
        
        // 检查API密钥状态并更新UI
        function checkApiKeyStatus() {
            // 获取DOM元素
            const sendBtn = document.getElementById('send-btn');
            const messageInput = document.getElementById('message-input');
            
            // 从本地存储获取设置
            const savedSettings = localStorage.getItem('gameSettings');
            let aiProvider = 'deepseek';
            let apiKey = '';
            let customEndpoint = '';
            
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                if (settings.aiProvider) {
                    aiProvider = settings.aiProvider;
                }
                if (settings.apiKey) {
                    apiKey = settings.apiKey;
                }
                if (settings.customEndpoint) {
                    customEndpoint = settings.customEndpoint;
                }
            }
            
            // 对于自定义服务商，需要检查是否有API端点
                // 对于其他服务商，需要检查是否有API密钥
                const hasApiKey = (aiProvider === 'custom' && customEndpoint) || apiKey;
            
            if (sendBtn) {
                sendBtn.disabled = !hasApiKey;
            }
            if (messageInput) {
                messageInput.disabled = !hasApiKey;
            }
            
            return hasApiKey;
        }

        // 初始化函数
        async function init() {
            // 检查是否是新游戏
            checkForNewGame();
            
            // 初始化默认设置（如果本地存储中没有）
            initializeDefaultSettings();
            
            // 检查API密钥状态
            const hasApiKey = checkApiKeyStatus();
            if (!hasApiKey) {
                addMessage('请先在设置页面配置API密钥', false);
            }
            
            // 加载存储的故事数据
            loadStoryData();
            
            // 启动游戏引擎
            startEngine();
            
            // 加载成就数据
            await loadAchievementsData();
            
            // 更新故事字数统计
            updateStoryWordCounts();
            
            // 更新当前时间
            updateCurrentTime();
            
            // 设置时间更新定时器
            setInterval(updateCurrentTime, 1000);
            
            // 检查本地存储中是否有错误信息，如果有则显示错误提示盒
            checkForSavedError();
        }
        
        // 初始化默认设置
        function initializeDefaultSettings() {
            console.log('initializeDefaultSettings - 开始执行');
            let savedSettings = localStorage.getItem('gameSettings');
            console.log('initializeDefaultSettings - 原始设置:', savedSettings);
            let settings;
            
            // 检查是否存在保存的设置，并且是否为有效的JSON
            if (savedSettings) {
                try {
                    settings = JSON.parse(savedSettings);
                    console.log('initializeDefaultSettings - 解析后的设置:', settings);
                    // 检查是否包含promptMode字段，并且是否明确设置为'simplified'
                    // 根据游戏逻辑，默认应该使用两阶段模式
                    if (!settings.promptMode || settings.promptMode !== 'simplified') {
                        // 如果没有promptMode字段，或者不是明确的'simplified'，则使用默认的两阶段模式
                        console.log('initializeDefaultSettings - promptMode不存在或不是simplified，设置为twoPhase');
                        settings.promptMode = 'twoPhase';
                        localStorage.setItem('gameSettings', JSON.stringify(settings));
                        console.log('initializeDefaultSettings - 已更新localStorage:', localStorage.getItem('gameSettings'));
                        // 确保PromptManager知道我们使用的是两阶段模式
                        PromptManager.setMode('twoPhase');
                        console.log('initializeDefaultSettings - 已调用PromptManager.setMode(twoPhase)');
                    } else {
                        console.log('initializeDefaultSettings - promptMode是simplified，保持不变');
                        // 确保PromptManager知道当前模式
                        PromptManager.setMode(settings.promptMode);
                        console.log('initializeDefaultSettings - 已调用PromptManager.setMode(simplified)');
                    }
                } catch (error) {
                    console.error('initializeDefaultSettings - 解析保存的设置失败，使用默认设置:', error);
                    settings = null;
                }
            } else {
                console.log('initializeDefaultSettings - 没有保存的设置');
            }
            
            if (!settings) {
                console.log('initializeDefaultSettings - 使用默认设置');
                // 没有保存的设置或设置无效，创建默认设置
                let defaultApiKey = '';
                // 检查是否存在Utils.getDefaultApiKey()函数，如果存在，就使用它来获取默认的API密钥
                if (typeof Utils !== 'undefined' && Utils.getDefaultApiKey) {
                    try {
                        defaultApiKey = Utils.getDefaultApiKey();
                        console.log('initializeDefaultSettings - 获取到默认API密钥:', defaultApiKey);
                    } catch (error) {
                        console.error('initializeDefaultSettings - 获取默认API密钥失败:', error);
                    }
                }
                const defaultSettings = {
                    aiProvider: 'deepseek',
                    aiModel: 'deepseek-chat',
                    apiKey: defaultApiKey,
                    promptMode: 'twoPhase' // 默认使用两阶段模式
                };
                localStorage.setItem('gameSettings', JSON.stringify(defaultSettings));
                console.log('initializeDefaultSettings - 已保存默认设置到localStorage:', localStorage.getItem('gameSettings'));
                // 确保PromptManager知道我们使用的是两阶段模式
                PromptManager.setMode('twoPhase');
                console.log('initializeDefaultSettings - 已调用PromptManager.setMode(twoPhase)');
            }
            console.log('initializeDefaultSettings - 执行完成');
        }
        
        // 检查本地存储中是否有错误信息
        function checkForSavedError() {
            const savedError = localStorage.getItem('lastError');
            if (savedError) {
                try {
                    const errorInfo = JSON.parse(savedError);
                    const errorType = errorInfo.errorType || 'story_generation';
                    
                    if (errorType === 'story_generation') {
                        // 故事生成阶段错误：显示错误提示盒，不自动重试
                        showErrorBox(errorInfo.phase, errorInfo.errorMessage);
                    } else {
                        // 故事解析或故事压缩阶段错误：自动重试
                        removeErrorBox();
                        // 这里可以添加具体的重试逻辑
                        console.log('自动重试错误操作:', errorType);
                    }
                } catch (error) {
                    console.error('解析错误信息失败:', error);
                    // 清除无效的错误信息
                    localStorage.removeItem('lastError');
                }
            }
        }
        
        // 检查是否是新游戏
        function checkForNewGame() {
            console.log('checkForNewGame - 开始执行');
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const newGame = urlParams.get('newgame');
            console.log('checkForNewGame - newGame参数:', newGame);
            
            if (newGame === 'true') {
                console.log('checkForNewGame - 处理新游戏请求');
                // 清空所有故事数据
                StoryStorage.clearAll();
                console.log('checkForNewGame - 已清空所有故事数据');
                
                // 重置游戏设置，使用默认的两阶段模式
                let defaultApiKey = '';
                // 检查是否存在Utils.getDefaultApiKey()函数，如果存在，就使用它来获取默认的API密钥
                if (typeof Utils !== 'undefined' && Utils.getDefaultApiKey) {
                    try {
                        defaultApiKey = Utils.getDefaultApiKey();
                        console.log('checkForNewGame - 获取到默认API密钥:', defaultApiKey);
                    } catch (error) {
                        console.error('checkForNewGame - 获取默认API密钥失败:', error);
                    }
                }
                const defaultSettings = {
                    aiProvider: 'deepseek',
                    aiModel: 'deepseek-chat',
                    apiKey: defaultApiKey,
                    promptMode: 'twoPhase' // 默认使用两阶段模式
                };
                console.log('checkForNewGame - 准备保存默认设置:', defaultSettings);
                localStorage.setItem('gameSettings', JSON.stringify(defaultSettings));
                console.log('checkForNewGame - 已保存默认设置到localStorage:', localStorage.getItem('gameSettings'));
                
                // 确保PromptManager知道我们使用的是两阶段模式
                PromptManager.setMode('twoPhase');
                console.log('checkForNewGame - 已调用PromptManager.setMode(twoPhase)');
                
                console.log('checkForNewGame - 新游戏处理完成');
            }
            console.log('checkForNewGame - 执行完成');
        }
        
        // 加载故事数据
        function loadStoryData() {
            // 从StoryStorage加载数据
            const storyData = StoryStorage.loadAll();
            
            fullStory = storyData.fullStory || [];
            compressedStory = storyData.compressedStory || [];
            uncompressedStory = storyData.uncompressedStory || [];
            latestUserMessage = storyData.latestUserMessage;
            
            // 显示未压缩故事（实时故事）给玩家
            displayUncompressedStory();
        }
        
        // 显示未压缩故事（实时故事）给玩家
        function displayUncompressedStory() {
            // 确保messagesContainer已初始化
            if (!messagesContainer) {
                // 尝试获取messagesContainer元素
                messagesContainer = document.getElementById('messages');
                if (!messagesContainer) {
                    console.error('消息容器未找到，无法显示故事');
                    return;
                }
            }
            
            if (uncompressedStory.length > 0) {
                // 清空现有消息
                messagesContainer.innerHTML = '';
                
                // 显示未压缩故事
                uncompressedStory.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.role === 'user' ? 'user' : 'ai'}`;
                    messageDiv.textContent = msg.content;
                    messagesContainer.appendChild(messageDiv);
                });
                
                // 滚动到底部
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                console.log('已显示未压缩故事，消息数:', uncompressedStory.length);
            }
        }
        
        // 启动游戏引擎
        async function startEngine() {
            console.log('开始启动游戏引擎');
            try {
                // 初始化游戏引擎
                const initResult = await GameEngineInstance.initialize();
                if (initResult.success) {
                    console.log('游戏引擎初始化成功:', initResult.message);
                    // 获取引擎状态
                    const status = GameEngineInstance.getStatus();
                    console.log('游戏引擎状态:', status);
                } else {
                    console.error('游戏引擎初始化失败:', initResult.error);
                }
            } catch (error) {
                console.error('启动游戏引擎错误:', error);
            }
        }
        
        // 添加消息到聊天界面
        async function addMessage(content, isUser = false) {
            // 确保messagesContainer已初始化
            if (!messagesContainer) {
                // 尝试获取messagesContainer元素
                messagesContainer = document.getElementById('messages');
                if (!messagesContainer) {
                    console.error('消息容器未找到，无法显示消息:', content);
                    return;
                }
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            messageDiv.textContent = content;
            
            // 添加消息到容器
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // 如果是用户消息，隐藏版本号
            if (isUser) {
                const versionInfo = document.querySelector('.version-info');
                if (versionInfo) {
                    versionInfo.style.display = 'none';
                }
            }
            
            // 计算消息字数
            const messageWordCount = content.length;
            
            // 创建未压缩故事的消息对象（包含时间戳）
            const uncompressedMessageObj = { 
                role: isUser ? 'user' : 'assistant', 
                content: content,
                timestamp: new Date().toISOString(),
                wordCount: messageWordCount
            };
            
            // 创建完整故事的消息对象（不包含时间戳）
            const fullMessageObj = { 
                role: isUser ? 'user' : 'assistant', 
                content: content
            };
            
            // 更新未压缩故事（实时故事）- 包含时间戳
            uncompressedStory.push(uncompressedMessageObj);
            
            // 更新完整故事 - 不包含时间戳
            fullStory.push(fullMessageObj);
            
            // 如果是用户消息，更新最新用户消息
            if (isUser) {
                latestUserMessage = uncompressedMessageObj;
            }
            
            // 更新字数统计
            if (!isUser) { // 只统计AI的故事内容
                try {
                    // 获取当前游戏数据
                    const gameData = GameEngineInstance.getGameData();
                    
                    // 计算当前节拍
                    const currentBeat = gameData.narrative?.storyBeat || '起';
                    
                    // 更新当前节拍的字数
                    if (gameData.narrative?.beatStats?.current) {
                        gameData.narrative.beatStats.current[currentBeat] = 
                            (gameData.narrative.beatStats.current[currentBeat] || 0) + messageWordCount;
                    }
                    
                    // 更新当前循环字数
                    gameData.narrative.currentCycleWords = 
                        (gameData.narrative.currentCycleWords || 0) + messageWordCount;
                    
                    // 更新总字数
                    gameData.narrative.totalWords = 
                        (gameData.narrative.totalWords || 0) + messageWordCount;
                    
                    // 保存更新后的数据
                    await GameEngineInstance.saveGameData();
                    
                    console.log(`字数统计更新：当前节拍[${currentBeat}]增加${messageWordCount}字，总字数${gameData.narrative.totalWords}`);
                } catch (error) {
                    console.error('更新字数统计失败:', error);
                }
            }
            
            // 检查是否需要压缩上下文
            if (ContextCompressor.shouldCompress(uncompressedStory)) {
                console.log('检测到未压缩消息数达到阈值，准备进行压缩');
                
                // 从本地存储获取API密钥
                const savedSettings = localStorage.getItem('gameSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
            const apiKey = settings.apiKey;
            const aiProvider = settings.aiProvider || 'deepseek';
            const aiModel = settings.aiModel || 'deepseek-chat';
                    
                    // 处理自定义服务商设置
                    let customSettings = null;
                    if (aiProvider === 'custom') {
                        customSettings = {
                            model: settings.customModel || 'custom',
                            endpoint: settings.customEndpoint || ''
                        };
                    }
                    
                    if ((apiKey || aiProvider === 'deepseek') || (aiProvider === 'custom' && customSettings.endpoint)) {
                        try {
                            // 压缩最早的16条消息
                        const messagesToCompress = uncompressedStory.slice(0, 16);
                        const compressedMessage = await ContextCompressor.compressContext(messagesToCompress, apiKey, aiProvider, aiModel, customSettings);
                        if (compressedMessage) {
                            // 更新压缩故事
                            compressedStory.push(compressedMessage);
                            
                            // 保留最后8条未压缩消息作为叙事风格稳定器
                            uncompressedStory = uncompressedStory.slice(16);
                            
                            console.log('上下文压缩完成，压缩故事数:', compressedStory.length, '保留的未压缩故事数:', uncompressedStory.length);
                        }
                        } catch (error) {
                            console.error('压缩上下文失败:', error);
                        }
                    }
                }
            }
            
            // 保存所有故事数据
            saveStoryData();
            
            // 输出故事数据状态
            const fullStoryWords = calculateStoryWords(fullStory);
            const compressedStoryWords = calculateStoryWords(compressedStory);
            const uncompressedStoryWords = calculateStoryWords(uncompressedStory);
            console.log('故事数据状态：完整故事字数:', fullStoryWords, '压缩故事字数:', compressedStoryWords, '未压缩故事字数:', uncompressedStoryWords);
        }
        
        // 保存故事数据
        function saveStoryData() {
            StoryStorage.saveAll(fullStory, compressedStory, uncompressedStory, latestUserMessage);
            // 更新故事字数统计
            updateStoryWordCounts();
        }
        
        // 保存最后一条消息
        let lastMessage = '';
        
        // 发送消息
        async function sendMessage() {
            // 获取DOM元素
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            
            if (!messageInput || !sendBtn) {
                console.error('消息输入框或发送按钮未找到');
                return;
            }
            
            const message = messageInput.value.trim();
            if (message) {
                // 保存最后一条消息
                lastMessage = message;
                
                // 添加用户消息
                await addMessage(message, true);
                messageInput.value = '';
                // 重置输入框高度为一行
                messageInput.style.height = 'auto';
                
                // 禁用发送按钮和输入框，防止重复发送
                sendBtn.disabled = true;
                sendBtn.textContent = '...';
                messageInput.disabled = true;
                
                try {
                    // 检查当前模式
                    const currentMode = PromptManager.getCurrentMode();
                    console.log('当前模式:', currentMode);
                    
                    if (currentMode === 'twoPhase') {
                        console.log('使用两阶段模式');
                        // 使用两阶段模式
                        await sendMessageTwoPhase(message);
                    } else {
                        console.log('使用简略模式');
                        // 使用简略模式
                        showLoading('世界加载中...');
                        // 调用AI API获取回复
                        const aiResponse = await callAIApi(message);
                        
                        // 使用游戏引擎处理AI响应
                        const processResult = await GameEngineInstance.processAIResponse(aiResponse);
                        
                        // 添加处理后的故事到聊天界面
                        await addMessage(processResult.story);
                        
                        hideLoading();
                    }
                    
                    // 成功发送后清除最后一条消息
                    lastMessage = '';
                    // 清除本地存储中的错误信息
                    localStorage.removeItem('lastError');
                } catch (error) {
                    console.error('调用API失败:', error);
                    showErrorBox('简略模式', error.message || '未知错误');
                } finally {
                    // 隐藏加载条
                    hideLoading();
                    // 恢复发送按钮和输入框
                    sendBtn.disabled = false;
                    sendBtn.textContent = '➤';
                    messageInput.disabled = false;
                }
            }
        }
        
        // 两阶段交互逻辑
        async function sendMessageTwoPhase(message) {
            console.log('开始两阶段交互:', message);
            try {
                // 阶段一：故事讲述者
                console.log('阶段一：故事讲述者');
                showLoading('世界加载中...');
                
                // 调用故事讲述者API
                console.log('调用故事讲述者API');
                const storytellerResult = await callStorytellerAPI(message);
                console.log('故事讲述者API调用完成:', storytellerResult);
                
                // 添加故事到聊天界面
                console.log('添加故事到聊天界面:', storytellerResult.story);
                await addMessage(storytellerResult.story);
                console.log('故事添加完成');
                
                // 阶段二：故事记录者
                console.log('阶段二：故事记录者');
                showLoading('世界解算中...');
                
                // 调用故事记录者API
                console.log('调用故事记录者API');
                const recorderResult = await callRecorderAPI(storytellerResult.story, storytellerResult.secretInfo);
                console.log('故事记录者API调用完成:', recorderResult);
                
                // 使用游戏引擎处理记录者响应
                console.log('使用游戏引擎处理记录者响应');
                const processResult = await GameEngineInstance.processAIResponse(recorderResult);
                console.log('游戏引擎处理完成:', processResult);
                
                // 添加处理后的故事到聊天界面
                console.log('添加处理后的故事到聊天界面:', processResult.story);
                await addMessage(processResult.story);
                console.log('处理后的故事添加完成');
                
                console.log('两阶段交互完成');
            } catch (error) {
                console.error('两阶段交互失败:', error);
                // 检测失败阶段
                let phase = '未知阶段';
                if (error.message.includes('故事讲述者') || error.message.includes('阶段一')) {
                    phase = '阶段一（故事讲述者）';
                } else if (error.message.includes('故事记录者') || error.message.includes('阶段二')) {
                    phase = '阶段二（故事记录者）';
                }
                showErrorBox(phase, error.message || '未知错误');
            } finally {
                hideLoading();
            }
        }
        
        // 简略模式逻辑
        async function sendMessageSimplified(message) {
            try {
                // 调用通用API获取回复
                const aiResponse = await callAIApi(message);
                
                // 使用游戏引擎处理AI响应
                const processResult = await GameEngineInstance.processAIResponse(aiResponse);
                
                // 添加处理后的故事到聊天界面
                await addMessage(processResult.story);
            } catch (error) {
                console.error('调用API失败:', error);
                throw error;
            }
        }
        
        // 调用故事讲述者API - 第一阶段
        async function callStorytellerAPI(userMessage) {
            // 从本地存储获取API密钥
            const savedSettings = localStorage.getItem('gameSettings');
            if (!savedSettings) {
                throw new Error('请先在设置页面配置API密钥');
            }
            
            const settings = JSON.parse(savedSettings);
            const apiKey = settings.apiKey;
            const aiProvider = settings.aiProvider || 'deepseek';
            const aiModel = settings.aiModel || 'deepseek-chat';
            
            // 处理自定义服务商设置
            let customSettings = null;
            if (aiProvider === 'custom') {
                customSettings = {
                    model: settings.customModel || 'custom',
                    endpoint: settings.customEndpoint || ''
                };
                if (!customSettings.endpoint) {
                    throw new Error('请在设置页面配置自定义API端点');
                }
            } 
            
            // 检查API密钥
            if (!apiKey && aiProvider !== 'deepseek' && !(aiProvider === 'custom' && customSettings && customSettings.endpoint)) {
                throw new Error('请先在设置页面配置API密钥');
            }
            
            // 使用PromptBuilder_Storyteller准备请求数据并发送API请求
            const { requestData, apiKey: finalApiKey, aiProvider: finalAiProvider, aiModel: finalAiModel, providerConfig } = await PromptBuilder_Storyteller.prepareRequestData(
                apiKey, 
                userMessage, 
                compressedStory, 
                uncompressedStory, 
                latestUserMessage,
                aiProvider,
                aiModel,
                customSettings
            );
            
            // 发送API请求
            const storytellerResult = await PromptBuilder_Storyteller.sendApiRequest(requestData, finalApiKey, finalAiProvider, finalAiModel, providerConfig, null, null, customSettings);
            
            // 存储完整请求数据到调试数据
            debugData.phase1.input = JSON.stringify(requestData, null, 2);
            debugData.phase1.output = storytellerResult.story;
            debugData.lastApiRequest = debugData.phase1.input;
            debugData.lastAiResponse = debugData.phase1.output;
            if (window.DebugPanelInstance) {
                window.DebugPanelInstance.updateContent();
            }
            
            // 更新调试面板显示
            updateDebugPanel();
            
            return storytellerResult;
        }
        
        // 调用故事记录者API - 第二阶段
        async function callRecorderAPI(story, secretInfo) {
            // 从本地存储获取API密钥
            const savedSettings = localStorage.getItem('gameSettings');
            if (!savedSettings) {
                throw new Error('请先在设置页面配置API密钥');
            }
            
            const settings = JSON.parse(savedSettings);
            const apiKey = settings.apiKey;
            const aiProvider = settings.aiProvider || 'deepseek';
            const aiModel = settings.aiModel || 'deepseek-chat';
            
            // 处理自定义服务商设置
            let customSettings = null;
            if (aiProvider === 'custom') {
                customSettings = {
                    model: settings.customModel || 'custom',
                    endpoint: settings.customEndpoint || ''
                };
                if (!customSettings.endpoint) {
                    throw new Error('请在设置页面配置自定义API端点');
                }
            } else if (!apiKey && aiProvider !== 'deepseek') {
                throw new Error('请先在设置页面配置API密钥');
            }
            
            // 使用PromptBuilder_Recorder准备请求数据并发送API请求
            const { requestData, apiKey: finalApiKey, aiModel: finalAiModel, providerConfig } = await PromptBuilder_Recorder.prepareRequestData(
                apiKey, 
                story, 
                secretInfo, 
                compressedStory, 
                uncompressedStory,
                aiProvider,
                aiModel,
                customSettings
            );
            
            const response = await PromptBuilder_Recorder.sendApiRequest(requestData, finalApiKey, aiProvider, aiModel, providerConfig, null, null, customSettings);
            
            // 存储完整请求数据到调试数据
            debugData.phase2.input = JSON.stringify(requestData, null, 2);
            debugData.phase2.output = response;
            debugData.lastApiRequest = debugData.phase2.input;
            debugData.lastAiResponse = debugData.phase2.output;
            if (window.DebugPanelInstance) {
                window.DebugPanelInstance.updateContent();
            }
            
            // 更新调试面板显示
            updateDebugPanel();
            
            return response;
        }
        
        
        // 显示错误提示盒
        function showErrorBox(phase, errorMessage) {
            // 确定错误类型
            let errorType = 'story_generation';
            if (phase.includes('解析')) {
                errorType = 'story_parsing';
            } else if (phase.includes('压缩')) {
                errorType = 'story_compression';
            }
            
            // 创建错误提示盒元素
            const errorBox = document.createElement('div');
            errorBox.className = 'error-box';
            errorBox.id = 'error-box';
            
            // 设置错误提示内容
            errorBox.innerHTML = `
                <h4>AI回复失败</h4>
                <p><strong>失败阶段：</strong>${phase}</p>
                <p><strong>失败原因：</strong>${errorMessage}</p>
                <div class="error-buttons">
                    <button class="error-button settings">设置</button>
                    <button class="error-button retry">重试</button>
                    <button class="error-button cancel">取消</button>
                </div>
            `;
            
            // 添加事件监听器
            const settingsBtn = errorBox.querySelector('.settings');
            const retryBtn = errorBox.querySelector('.retry');
            const cancelBtn = errorBox.querySelector('.cancel');
            
            if (settingsBtn) {
                settingsBtn.addEventListener('click', goToSettings);
            }
            
            if (retryBtn) {
                retryBtn.addEventListener('click', function() {
                    retryError(errorType);
                });
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    cancelError(errorType);
                });
            }
            
            // 添加到消息容器
            if (messagesContainer) {
                messagesContainer.appendChild(errorBox);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // 保存错误信息到本地存储，确保刷新后不会消失
            const errorInfo = {
                phase,
                errorMessage,
                errorType,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('lastError', JSON.stringify(errorInfo));
        }
        
        // 前往设置页面
        function goToSettings() {
            window.location.href = 'settings.html';
        }
        
        // 重试最后一条消息
        function retryLastMessage() {
            // 移除错误提示盒
            removeErrorBox();
            
            // 删除最后一条用户消息
            if (uncompressedStory.length > 0 && uncompressedStory[uncompressedStory.length - 1].role === 'user') {
                uncompressedStory.pop();
            }
            if (fullStory.length > 0 && fullStory[fullStory.length - 1].role === 'user') {
                fullStory.pop();
            }
            
            // 保存故事数据
            saveStoryData();
            
            // 重新显示消息
            displayUncompressedStory();
            
            // 恢复最后一条消息到输入框
            const messageInput = document.getElementById('message-input');
            if (messageInput && lastMessage) {
                messageInput.value = lastMessage;
                // 调整输入框高度
                messageInput.style.height = 'auto';
                messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
                // 聚焦输入框
                messageInput.focus();
                // 重新发送消息
                sendMessage();
            }
        }
        
        // 取消最后一条消息
        function cancelLastMessage() {
            // 移除错误提示盒
            removeErrorBox();
            
            // 删除最后一条用户消息
            if (uncompressedStory.length > 0 && uncompressedStory[uncompressedStory.length - 1].role === 'user') {
                uncompressedStory.pop();
            }
            if (fullStory.length > 0 && fullStory[fullStory.length - 1].role === 'user') {
                fullStory.pop();
            }
            
            // 清除最后一条消息
            lastMessage = '';
            
            // 保存故事数据
            saveStoryData();
            
            // 重新显示消息
            displayUncompressedStory();
        }
        
        // 移除错误提示盒
        function removeErrorBox() {
            const errorBox = document.getElementById('error-box');
            if (errorBox) {
                errorBox.remove();
            }
            
            // 清除本地存储中的错误信息
            localStorage.removeItem('lastError');
        }
        
        // 重试错误操作
        function retryError(errorType) {
            // 移除错误提示盒
            removeErrorBox();
            
            if (errorType === 'story_generation') {
                // 故事生成阶段错误：重新发送当前的回复
                // 删除最后一条用户消息
                if (uncompressedStory.length > 0 && uncompressedStory[uncompressedStory.length - 1].role === 'user') {
                    uncompressedStory.pop();
                }
                if (fullStory.length > 0 && fullStory[fullStory.length - 1].role === 'user') {
                    fullStory.pop();
                }
                
                // 保存故事数据
                saveStoryData();
                
                // 重新显示消息
                displayUncompressedStory();
                
                // 恢复最后一条消息到输入框
                const messageInput = document.getElementById('message-input');
                if (messageInput && lastMessage) {
                    messageInput.value = lastMessage;
                    // 调整输入框高度
                    messageInput.style.height = 'auto';
                    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
                    // 聚焦输入框
                    messageInput.focus();
                    // 重新发送消息
                    sendMessage();
                }
            } else {
                // 故事解析或故事压缩阶段错误：重新发出这一阶段的申请
                // 这里需要根据具体的错误类型重新执行相应的操作
                // 暂时只关闭错误提示盒
                // 实际实现需要根据具体的错误类型调用相应的函数
            }
        }
        
        // 取消错误操作
        function cancelError(errorType) {
            // 移除错误提示盒
            removeErrorBox();
            
            if (errorType === 'story_generation') {
                // 故事生成阶段错误：删除当前的回复
                // 删除最后一条用户消息
                if (uncompressedStory.length > 0 && uncompressedStory[uncompressedStory.length - 1].role === 'user') {
                    uncompressedStory.pop();
                }
                if (fullStory.length > 0 && fullStory[fullStory.length - 1].role === 'user') {
                    fullStory.pop();
                }
                
                // 清除最后一条消息
                lastMessage = '';
                
                // 保存故事数据
                saveStoryData();
                
                // 重新显示消息
                displayUncompressedStory();
            } else {
                // 故事解析或故事压缩阶段错误：只关闭错误提示盒，输入框被停用，发送键变成重试
                const messageInput = document.getElementById('message-input');
                const sendBtn = document.getElementById('send-btn');
                
                if (messageInput) {
                    messageInput.disabled = true;
                }
                
                if (sendBtn) {
                    sendBtn.textContent = '重试';
                    sendBtn.style.backgroundColor = '#f44336';
                    sendBtn.style.color = 'white';
                    sendBtn.onclick = function() {
                        // 重新启用输入框和发送按钮
                        if (messageInput) {
                            messageInput.disabled = false;
                        }
                        if (sendBtn) {
                            sendBtn.textContent = '➤';
                            sendBtn.style.backgroundColor = '';
                            sendBtn.style.color = '';
                            sendBtn.onclick = sendMessage;
                        }
                    };
                }
            }
        }
        
        // 调用AI API（简略模式）
        async function callAIApi(userMessage) {
            // 从本地存储获取API密钥
            const savedSettings = localStorage.getItem('gameSettings');
            let apiKey = '';
            let aiProvider = 'deepseek';
            let aiModel = 'deepseek-chat';
            let customSettings = null;
            
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                if (settings.apiKey) {
                    apiKey = settings.apiKey;
                }
                if (settings.aiProvider) {
                    aiProvider = settings.aiProvider;
                }
                if (settings.aiModel) {
                    aiModel = settings.aiModel;
                }
                // 处理自定义服务商设置
                if (aiProvider === 'custom') {
                    customSettings = {
                        model: settings.customModel || 'custom',
                        endpoint: settings.customEndpoint || ''
                    };
                    if (!customSettings.endpoint) {
                        throw new Error('请在设置页面配置自定义API端点');
                    }
                }
            }
            
            // 检查是否有API密钥
            if (!apiKey && !(aiProvider === 'custom' && customSettings.endpoint)) {
                throw new Error('请在设置页面配置API密钥');
            }
            
            // 使用PromptManager加载简略模式提示词
            const prompts = await PromptManager.loadPrompts('simplified');
            
            // 拼装系统提示词
            let fullSystemPrompt = prompts.systemPrompt.trim();
            fullSystemPrompt += "\n\n===游戏规则部分结束===";
            
            if (prompts.loreContent) {
                fullSystemPrompt += "\n\n===世界设定部分开始===\n\n" + prompts.loreContent.trim();
                fullSystemPrompt += "\n\n===世界设定部分结束===";
            }
            
            if (prompts.dataContent) {
                fullSystemPrompt += "\n\n===数据部分开始===\n\n" + prompts.dataContent.trim();
                fullSystemPrompt += "\n\n===数据部分结束===";
            }
            
            // 准备消息
            const messages = [];
            if (fullSystemPrompt) {
                messages.push({ role: 'system', content: fullSystemPrompt });
            }
            
            if (compressedStory.length > 0) {
                messages.push({
                    role: 'system',
                    content: '===摘要部分开始==='
                });
                compressedStory.forEach(msg => {
                    if (msg && msg.content) {
                        messages.push({
                            role: msg.role || 'assistant',
                            content: msg.content
                        });
                    }
                });
                messages.push({
                    role: 'system',
                    content: '===摘要部分结束==='
                });
            }
            
            if (uncompressedStory.length > 0) {
                messages.push({
                    role: 'system',
                    content: '===故事部分开始==='
                });
                const storyToSend = uncompressedStory.slice(0, -1);
                storyToSend.forEach(msg => {
                    if (msg && msg.role && msg.content) {
                        messages.push({
                            role: msg.role,
                            content: msg.content
                        });
                    }
                });
                messages.push({
                    role: 'system',
                    content: '===故事部分结束==='
                });
            }
            
            if (userMessage) {
                messages.push({
                    role: 'system',
                    content: '===用户输入开始==='
                });
                messages.push({ role: 'user', content: userMessage });
                messages.push({
                    role: 'system',
                    content: '===用户输入结束===\n\n请以故事主持人的身份开始渲染故事，并使用游戏引擎更新和记录故事的状态。'
                });
            }
            
            // 使用ProviderConfig构建请求配置
            const { endpoint, requestConfig } = ProviderConfig.buildRequestConfig(aiProvider, aiModel, messages, apiKey, customSettings);
            
            // 存储完整请求数据到调试数据
            debugData.lastApiRequest = JSON.stringify(requestConfig, null, 2);
            if (window.DebugPanelInstance) {
                window.DebugPanelInstance.updateContent();
            }
            
            // 更新调试面板显示
            updateDebugPanel();
            
            // 发送API请求
            const response = await fetch(endpoint, requestConfig);
            
            if (!response.ok) {
                try {
                    const errorData = await response.json();
                    // 检查是否是余额不足错误
                    if (errorData.error && 
                        ((typeof errorData.error === 'string' && errorData.error.includes('余额不足')) ||
                         (errorData.error.message && errorData.error.message.includes('余额不足')))) {
                        throw new Error(`API余额不足，请在设置页面配置您自己的${aiProvider} API密钥: ${response.status} ${errorData.error.message || errorData.error}`);
                    }
                    let errorMessage;
                    if (errorData.error) {
                        if (typeof errorData.error === 'string') {
                            errorMessage = errorData.error;
                        } else if (errorData.error.message) {
                            errorMessage = errorData.error.message;
                        } else {
                            errorMessage = JSON.stringify(errorData.error);
                        }
                    } else {
                        errorMessage = '';
                    }
                    throw new Error(`API请求失败: ${response.status} ${errorMessage}`);
                } catch (parseError) {
                    throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                }
            }
            
            const responseData = await response.json();
            
            // 使用ProviderConfig处理API响应
            const content = ProviderConfig.processApiResponse(aiProvider, responseData);
            
            // 存储最后一次AI回复到调试数据
            debugData.lastAiResponse = content;
            if (window.DebugPanelInstance) {
                window.DebugPanelInstance.updateContent();
            }
            
            // 更新调试面板显示
            updateDebugPanel();
            
            return content;
        }
        

        
        // 初始化DOM元素
        let sendBtn = null;
        let messageInput = null;
        let messagesContainer = null;
        
        // 事件监听
        if (sendBtn) {
            sendBtn.addEventListener('click', sendMessage);
        }
        
        if (messageInput) {
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }
        
        // 自动调整输入框高度并更新字数统计
        if (messageInput) {
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
                
                // 更新字数统计
                const charCount = document.getElementById('char-count');
                if (charCount) {
                    const currentLength = messageInput.value.length;
                    charCount.textContent = `${currentLength}/500`;
                    // 当接近或达到字数限制时，改变颜色提醒用户
                    if (currentLength >= 480) {
                        charCount.style.color = '#f44336';
                    } else {
                        charCount.style.color = '#999';
                    }
                }
            });
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', function() {
            // 重新获取DOM元素，确保DOM已完全加载
            sendBtn = document.getElementById('send-btn');
            messageInput = document.getElementById('message-input');
            messagesContainer = document.getElementById('messages');
            
            // 添加事件监听
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            
            if (messageInput) {
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                messageInput.addEventListener('input', () => {
                    messageInput.style.height = 'auto';
                    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
                    
                    // 更新字数统计
                    const charCount = document.getElementById('char-count');
                    if (charCount) {
                        const currentLength = messageInput.value.length;
                        charCount.textContent = `${currentLength}/500`;
                        // 当接近或达到字数限制时，改变颜色提醒用户
                        if (currentLength >= 480) {
                            charCount.style.color = '#f44336';
                        } else {
                            charCount.style.color = '#999';
                        }
                    }
                });
            }
            
            init();
            // 初始化调试面板选项卡显示状态
            updateDebugTabsVisibility();
        });
        
        // 当页面获得焦点时，重新检查API密钥状态
        window.addEventListener('focus', function() {
            const hasApiKey = checkApiKeyStatus();
            if (hasApiKey) {
                // 如果之前没有API密钥，现在有了，显示提示消息
                console.log('API密钥已配置，控件已启用');
            }
        });
        
        // 窗口大小变化时调整输入框宽度
        window.addEventListener('resize', function() {
            if (messageInput) {
                // 重置输入框高度，确保在窗口大小变化时重新计算
                messageInput.style.height = 'auto';
                // 触发input事件，确保输入框重新调整
                const event = new Event('input', { bubbles: true });
                messageInput.dispatchEvent(event);
            }
        });
        
        // 切换成就面板显示/隐藏
        function toggleAchievementsPanel() {
            if (achievementsPanel.style.display === 'none' || achievementsPanel.style.display === '') {
                achievementsPanel.style.display = 'block';
                // 每次打开时重新加载成就数据
                loadAchievementsData();
            } else {
                achievementsPanel.style.display = 'none';
            }
        }
        
        // 加载成就数据
        async function loadAchievementsData() {
            try {
                // 从游戏引擎获取成就数据
                const achievementsData = GameEngineInstance.getAchievementsData();
                if (achievementsData && achievementsData.achievements) {
                    displayAchievements(achievementsData.achievements);
                } else {
                    // 如果游戏引擎未初始化，尝试直接从文件加载
                    const response = await fetch('src/data/achievements.json');
                    if (response.ok) {
                        const data = await response.json();
                        displayAchievements(data.achievements);
                    } else {
                        throw new Error('加载成就数据失败');
                    }
                }
            } catch (error) {
                console.error('加载成就数据错误:', error);
                achievementsContent.innerHTML = '<div class="error">加载成就失败</div>';
            }
        }
        
        // 显示成就列表
        function displayAchievements(achievements) {
            if (!achievements || achievements.length === 0) {
                achievementsContent.innerHTML = '<div class="no-achievements">暂无成就</div>';
                return;
            }
            
            // 过滤出可见的成就和已完成的隐藏成就
            const visibleAchievements = achievements.filter(achievement => !achievement.isHidden || achievement.isCompleted);
            
            if (visibleAchievements.length === 0) {
                achievementsContent.innerHTML = '<div class="no-achievements">暂无可见成就</div>';
                return;
            }
            
            // 按完成状态排序
            visibleAchievements.sort((a, b) => {
                if (a.isCompleted && !b.isCompleted) return -1;
                if (!a.isCompleted && b.isCompleted) return 1;
                return 0;
            });
            
            let html = '';
            
            visibleAchievements.forEach(achievement => {
                const className = `achievement-item ${achievement.isCompleted ? 'completed' : ''} ${achievement.isHidden ? 'hidden' : ''}`;
                const statusText = achievement.isCompleted ? '已完成' : '未完成';
                
                // 为特定成就添加按钮
                let buttonHtml = '';
                if (achievement.isCompleted) {
                    if (achievement.name === '霞中车') {
                        buttonHtml = '<button class="achievement-btn" onclick="handleXiaZhongCheClick()">获得管理员权限</button>';
                    } else if (achievement.name === '绸间塔') {
                        buttonHtml = '<button class="achievement-btn" onclick="handleChouJianTaClick()">失去管理员权限</button>';
                    } else if (achievement.name === '雾上灯') {
                        buttonHtml = '<button class="achievement-btn" onclick="handleWuShangDengClick()">前往GitHub</button>';
                    }
                }
                
                html += `
                    <div class="${className}">
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-description">${achievement.description}</div>
                        <div class="achievement-status">状态: ${statusText}</div>
                        ${buttonHtml}
                    </div>
                `;
            });
            
            achievementsContent.innerHTML = html;
        }
        
        // 切换调试面板显示/隐藏
        function toggleDebugPanel() {
            // 优先使用DebugPanelInstance的togglePanel方法（如果存在）
            if (window.DebugPanelInstance) {
                window.DebugPanelInstance.togglePanel();
            } else {
                // 兼容处理：直接控制调试面板的显示/隐藏
                const debugPanel = document.getElementById('debugPanel');
                if (debugPanel) {
                    // 切换open类来控制滑入滑出效果
                    if (debugPanel.classList.contains('open')) {
                        debugPanel.classList.remove('open');
                    } else {
                        debugPanel.classList.add('open');
                        // 每次显示时更新调试面板内容
                        updateDebugPanel();
                        // 更新选项卡显示状态
                        updateDebugTabsVisibility();
                    }
                }
            }
        }
        
        // 处理霞中车成就按钮点击（获得admin权限）
        function handleXiaZhongCheClick() {
            console.log('点击霞中车成就按钮，获得admin权限');
            // 设置admin权限为true
            admin = true;
            window.admin = true;
            // 保持admin属性可配置，以便后续可以修改
            Object.defineProperty(window, 'admin', {
                value: true,
                writable: true,
                configurable: true
            });
            console.log('admin权限已设置为:', window.admin);
            
            // 显示调试按钮
            const debugToggle = document.getElementById('debugToggle');
            if (debugToggle) {
                debugToggle.style.display = 'block';
            }
            
            // 初始化DebugPanelInstance（如果尚未初始化）
            if (typeof DebugPanel !== 'undefined' && !window.DebugPanelInstance) {
                window.DebugPanelInstance = new DebugPanel();
            }
            
            // 重新加载成就数据，更新UI
            loadAchievementsData();
            // 显示成功消息
            addMessage('你获得了管理员权限！', false);
        }
        
        // 处理绸间塔成就按钮点击（失去admin权限）
        function handleChouJianTaClick() {
            console.log('点击绸间塔成就按钮，失去admin权限');
            // 设置admin权限为false
            admin = false;
            window.admin = false;
            // 保持admin属性可配置，以便后续可以修改
            Object.defineProperty(window, 'admin', {
                value: false,
                writable: true,
                configurable: true
            });
            console.log('admin权限已设置为:', window.admin);
            
            // 隐藏调试面板和调试按钮
            const debugPanel = document.getElementById('debugPanel');
            const debugToggle = document.getElementById('debugToggle');
            
            // 关闭调试面板（如果打开）
            if (debugPanel) {
                debugPanel.classList.remove('open');
            }
            
            // 隐藏调试按钮
            if (debugToggle) {
                debugToggle.style.display = 'none';
            }
            
            // 清理DebugPanelInstance
            if (window.DebugPanelInstance) {
                window.DebugPanelInstance = undefined;
            }
            
            // 重新加载成就数据，更新UI
            loadAchievementsData();
            // 显示成功消息
            addMessage('你失去了管理员权限。', false);
        }
        
        // 处理雾上灯成就按钮点击（前往GitHub）
        function handleWuShangDengClick() {
            console.log('点击雾上灯成就按钮，前往GitHub');
            // 打开GitHub链接
            window.open('https://github.com/xcrv2000/a_glimpse_of_ascension/', '_blank');
        }
        
        // 切换调试标签页
        function switchDebugTab(tabId) {
            // 隐藏所有标签页
            document.querySelectorAll('.debug-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // 移除所有标签页的活动状态
            document.querySelectorAll('.debug-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签页
            const tabContent = document.getElementById(tabId + '-tab');
            if (tabContent) {
                tabContent.style.display = 'block';
            }
            
            // 设置选中标签页的活动状态
            const tabButton = document.querySelector(`.debug-tab[onclick="switchDebugTab('${tabId}')"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }
        }
        
        // 更新调试选项卡显示状态
        function updateDebugTabsVisibility() {
            const currentMode = PromptManager.getCurrentMode();
            const isSimplified = currentMode === 'simplified';
            
            // 获取所有选项卡
            const tabs = document.querySelectorAll('.debug-tab');
            
            // 显示/隐藏阶段标签页
            tabs.forEach(tab => {
                if (tab.onclick) {
                    const onclickStr = tab.onclick.toString();
                    if (onclickStr.includes('phase1') || onclickStr.includes('phase2')) {
                        // 阶段标签页：在简略模式下隐藏
                        tab.style.display = isSimplified ? 'none' : 'block';
                    } else if (onclickStr.includes('ai-data')) {
                        // AI输入/输出标签页：在完整模式下隐藏
                        tab.style.display = isSimplified ? 'block' : 'none';
                    }
                }
            });
            
            // 确保当前显示的是正确的选项卡
            if (isSimplified) {
                switchDebugTab('ai-data');
            } else {
                // 在两阶段模式下，默认显示阶段一标签页
                switchDebugTab('phase1');
            }
        }
        
        // 更新调试面板内容
        function updateDebugPanel() {
            // 更新游戏数据显示
            if (debugData.dataJson) {
                document.getElementById('dataJsonContent').textContent = debugData.dataJson;
            }
            
            // 更新引擎工具标签页
            if (GameEngineInstance) {
                try {
                    const gameData = GameEngineInstance.getGameData();
                    document.getElementById('current-beat').textContent = gameData.narrative?.storyBeat || '未知';
                    document.getElementById('current-beat-operation').textContent = gameData.narrative?.storyBeatOperation || '未知';
                    document.getElementById('current-depth-level').textContent = gameData.narrative?.depthLevel || '未知';
                    document.getElementById('current-time').textContent = gameData.gameState?.currentTime || '未知';
                } catch (error) {
                    console.error('更新引擎工具标签页失败:', error);
                }
            }
            
            // 更新AI输入/输出标签页
            document.getElementById('aiInput').textContent = debugData.lastApiRequest || '无数据';
            document.getElementById('aiOutput').textContent = debugData.lastAiResponse || '无数据';
            
            // 更新AI数据标签页中的两阶段数据
            document.getElementById('phase1Input-ai').textContent = debugData.phase1.input || '无数据';
            document.getElementById('phase1Output-ai').textContent = debugData.phase1.output || '无数据';
            document.getElementById('phase2Input-ai').textContent = debugData.phase2.input || '无数据';
            document.getElementById('phase2Output-ai').textContent = debugData.phase2.output || '无数据';
            
            // 更新阶段一标签页
            document.getElementById('phase1Input').textContent = debugData.phase1.input || '无数据';
            document.getElementById('phase1Output').textContent = debugData.phase1.output || '无数据';
            
            // 更新阶段二标签页
            document.getElementById('phase2Input').textContent = debugData.phase2.input || '无数据';
            document.getElementById('phase2Output').textContent = debugData.phase2.output || '无数据';
        }
    </script>
    
    <script>
        // 从localStorage加载颜色设置
        function loadColors() {
            try {
                const savedColors = localStorage.getItem('gameColors');
                if (savedColors) {
                    const colors = JSON.parse(savedColors);
                    const root = document.documentElement;
                    
                    // 更新CSS变量
                    root.style.setProperty('--primary-color', colors.primary || '#1a2e3c');
                    root.style.setProperty('--secondary1-color', colors.secondary1 || '#f5f5f5');
                    root.style.setProperty('--secondary2-color', colors.secondary2 || '#b8c6db');
                    root.style.setProperty('--secondary3-color', colors.secondary3 || '#5a6670');
                    root.style.setProperty('--accent-color', colors.accent || '#cc5522');
                    root.style.setProperty('--neutral1-color', colors.neutral1 || '#4a3728');
                    root.style.setProperty('--neutral2-color', colors.neutral2 || '#333333');
                    root.style.setProperty('--neutral3-color', colors.neutral3 || '#666666');
                    root.style.setProperty('--neutral4-color', colors.neutral4 || '#999999');
                }
            } catch (error) {
                console.error('加载颜色设置失败:', error);
            }
        }
        
        // 页面加载时加载颜色设置
        window.addEventListener('load', loadColors);
    </script>
</body>
</html>