# 事件注册功能实现计划（最终版）

## 1. 数据结构设计
- 在 `data.json` 中添加 `events` 数组，存储事件信息
- 每个事件包含：
  - `name`: 事件名称（作为唯一标识）
  - `description`: 事件描述
  - `startTime`: 事件开始时间（只读，初始设置后不可修改）
  - `expectedEndTime`: 预期结束时间
  - `status`: 事件状态（foreground/background）
  - `participants`: 参与角色数组
  - `metadata`: 其他元数据（只读）

## 2. 响应解析扩展
- 在 `responseParser.js` 中添加事件相关解析逻辑
- 支持三种事件操作：
  - `registerEvent`: 注册新事件
  - `updateEvent`: 更新现有事件
  - `deleteEvent`: 删除事件
- 扩展数据请求格式，支持事件操作的解析
- 更新验证规则，确保事件数据格式正确

## 3. 事件管理逻辑
- 在 `engine.js` 中添加事件管理模块
- 实现事件注册、更新、删除功能
- 集成时间线机制，确保事件时间与游戏时间同步
- 添加事件时间检查，当事件预期结束时间到来时触发提醒
- 实现事件自动注销机制，当AI未更新事件结束时间时注销事件
- 实现事件名称冲突处理，同名事件视为同一事件并覆盖

## 4. 时间线集成
- 利用现有的时间线机制，为每条事件添加时间戳
- 在处理AI响应时，检查事件时间状态
- 确保事件时间与游戏当前时间保持一致
- 当游戏时间跨越事件预期结束时间时，触发事件处理

## 5. AI交互设计
- 在 `prompt.json` 中添加详细的事件工具使用说明
- 明确告知AI：
  - 事件是"给AI看的当前都有什么在发生"的备忘录和素材库
  - 事件通过名称识别，同名事件视为同一事件
  - 大部分字段（除startTime和metadata外）可以随时编辑
  - 事件状态分为前台（直接在故事中出现）和后台（在故事后台运行）
  - 前台和后台可以根据叙事需要相互转换
  - 当事件预期结束时间到来时，需要在故事中出现
  - 如果此时不更新预期结束时间，该事件会被注销

## 6. 实现步骤
1. **修改 data.json**：添加 events 数组结构
2. **扩展 responseParser.js**：添加事件操作解析和验证
3. **增强 engine.js**：添加事件管理逻辑和时间线集成
4. **更新 prompt.json**：添加详细的事件工具使用说明
5. **测试功能**：确保事件注册、更新、删除和状态转换功能正常工作

## 7. 技术要点
- 事件标识：使用事件名称作为唯一标识
- 时间格式：统一使用 YYYY-MM-DD HH:mm:ss 格式
- 状态管理：简化为前台/后台两种状态
- 错误处理：确保事件操作失败时不会影响游戏正常运行
- AI交互：通过清晰的指令格式，让AI能够正确使用事件机制
- 时间线同步：确保事件时间与游戏时间保持一致