## 节拍系统扩展实现计划

### 1. 修改 engine.js

#### 1.1 扩展节拍处理逻辑
* 修改 `processStoryBeatOperation` 方法，添加【节拍操作：完结】支持，使其在所有节拍都可以生效
* 添加终幕和后日谈的状态检查
* 实现时间线和字数检查，触发终幕
* 实现伟业达成后进入后日谈的逻辑

#### 1.2 添加操作限制
* 在 `registerEvent`、`addForeshadowing`、`registerCharacter` 等方法中添加终幕和后日谈的限制
* 在 `processTimeUpdate` 方法中添加后日谈的时间处理
* 确保终幕和后日谈中相关操作失效

### 2. 修改 responseParser.js

#### 2.1 扩展解析逻辑
* 添加【节拍操作：完结】的解析支持
* 在验证函数中添加终幕和后日谈的限制检查
* 确保不符合条件的操作被正确验证和处理

### 3. 修改 prompt.json

#### 3.1 添加终幕说明
* 终幕的触发条件（时间线到1929年或总字数超过30万字）
* 终幕的限制（不可以注册新伏笔、新角色，节拍操作失效）
* 终幕的建议（5万字总字数，解决重要伏笔，激进删除已解决的事件和伏笔）
* 终幕的写作指南（快速完结故事，解决所有矛盾）

#### 3.2 添加后日谈说明
* 后日谈的触发条件（【节拍操作：完结】在任何节拍都可生效，推荐在【合】节拍中使用）
* 后日谈的额外触发条件（AI认为故事已崩溃到无可挽回时）
* 后日谈的限制（不可以注册新事件、新伏笔、新角色，所有操作失效）
* 后日谈的时间处理（当前时间变为【后日谈】）
* 后日谈的写作指南（交代角色结局，扫清重要伏笔，描写世界未来）

### 4. 实现细节

#### 4.1 终幕触发逻辑
* 检查当前时间是否达到1929年
* 检查故事总字数是否超过30万字
* 当满足任一条件时，自动进入终幕

#### 4.2 后日谈触发逻辑
* 处理【节拍操作：完结】，在所有节拍中都可生效
* 当角色达成伟业时，在本轮循环的【合】节拍结束后进入后日谈
* 当AI认为故事已崩溃到无可挽回时，允许使用【节拍操作：完结】进入后日谈

#### 4.3 操作限制实现
* 在所有相关方法中添加状态检查
* 确保终幕和后日谈中的限制被严格执行
* 提供清晰的错误信息和日志

### 5. 测试与验证

* 测试终幕的触发条件和限制
* 测试后日谈的触发条件和限制
* 验证所有操作在终幕和后日谈中的行为
* 确保伟业达成后正确进入后日谈
* 确保故事崩溃时可以使用【节拍操作：完结】进入后日谈