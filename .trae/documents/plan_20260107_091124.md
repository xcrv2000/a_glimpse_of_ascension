# 实现上下文压缩功能

## 目标

创建一个独立的模块，用于在未压缩上下文过长时压缩上下文，将当前对话和上下文发送给AI进行压缩，并将压缩结果保存到单独的JSON文件中。

## 具体步骤

1. **创建新文件** **`contextCompressor.js`**

   * 实现 `ContextCompressor` 类模块

   * 包含以下功能：

     * `shouldCompress()`: 检查是否需要压缩上下文（基于上下文长度）

     * `compressContext()`: 将当前未压缩的对话发送给AI进行压缩

     * `saveCompressedContext()`: 将压缩结果保存到单独的 `compressed_context.json` 文件

     * `loadCompressedContext()`: 从 `compressed_context.json` 文件加载压缩的上下文

     * `updateChatHistory()`: 更新压缩后的上下文到聊天历史

2. **创建/使用** **`compressed_context.json`** **文件**

   * 用于存储从故事开始到当前的所有压缩上下文信息

   * 确保包含所有必要的故事信息

3. **修改** **`chat.html`** **文件**

   * 在head部分引入新的 `contextCompressor.js` 文件

   * 在初始化时加载压缩的上下文

   * 在 `addMessage` 函数中添加检查逻辑，当上下文过长时调用压缩功能

   * 集成上下文压缩到现有的聊天流程中

4. **修改** **`promptBuilder_storyteller.js`** **文件**

   * 更新提示词生成逻辑，按照以下顺序拼凑：

     1. prompt.json

     2. data.json

     3. 已压缩的上下文（从 compressed\_context.json）

     4. 未压缩的上下文（最近的对话）

     5. 当前用户发言

5. **确保功能完整性**

   * 保持所有现有功能不变

   * 确保上下文截断逻辑统一，不丢失对话

   * 确保上下文压缩逻辑正确执行

   * 验证压缩后的上下文仍然有效

   * 确保文件读写操作正常工作

## 技术要点

* 使用模块化设计，与现有的 `PromptBuilder` 模块保持一致

* 实现基于上下文长度的触发机制，当未压缩上下文过长时调用压缩

* 设计合理的压缩提示词，确保AI能够正确压缩上下文

* 保持与现有代码的兼容性，不影响正常的聊天流程

* 确保文件读写功能正常，防止数据丢失

