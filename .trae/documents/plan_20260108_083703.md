# 伏笔功能实现计划（调整版）

## 1. 数据结构设计

* 在 `data.json` 中添加 `foreshadowings` 数组，存储伏笔信息

* 每个伏笔包含：

  * `name`: 伏笔名称（作为唯一标识）

  * `description`: 伏笔描述（应当简短）

  * `occurrenceTime`: 发生时间

  * `importance`: 重要程度（1-5，用于排序和删除）

  * `meta`: 其他元数据

  * `currentTime`: 当前时间（用于时间线同步）

## 2. 响应解析扩展

* 在 `responseParser.js` 中添加伏笔相关解析逻辑

* 支持三种伏笔操作：

  * `addForeshadowing`: 添加新伏笔

  * `updateForeshadowing`: 更新现有伏笔

  * `removeForeshadowing`: 删除伏笔

* 扩展数据请求格式，支持伏笔操作的解析

* 更新验证规则，确保伏笔数据格式正确

## 3. 伏笔管理逻辑

* 在 `engine.js` 中添加伏笔管理模块

* 实现伏笔的添加、更新、删除功能

* 添加伏笔数量管理：

  * 当伏笔数超过12个时，建议AI删除最用不到的伏笔（不一定是权重最低的）

  * 当伏笔数超过20个时，强制删除权重最低的伏笔，多个最低权重随机删除

* 集成时间线机制，确保伏笔时间与游戏时间同步

* 实现伏笔的重要程度排序和管理

## 4. 时间线集成

* 利用现有的时间线机制，为每条伏笔添加时间戳

* 在处理AI响应时，检查伏笔数量和状态

* 确保伏笔时间与游戏当前时间保持一致

## 5. AI交互设计

* 在 `prompt.json` 中添加详细的伏笔工具使用说明

* 明确告知AI：

  * 伏笔是"以后的故事中可能用到的伏笔"

  * 伏笔应当简短，记录显著但未被解决的角色行为、怪事或现象

  * 伏笔不需要检查是否结束，也不必须被复用

  * 伏笔数超过12时，应当删除最用不到的伏笔

  * 伏笔仅作为AI生成故事的素材库，仅在需要时使用

## 6. 实现步骤

1. **修改 data.json**：添加 foreshadowings 数组结构
2. **扩展 responseParser.js**：添加伏笔操作解析和验证
3. **增强 engine.js**：添加伏笔管理逻辑和时间线集成
4. **更新 prompt.json**：添加详细的伏笔工具使用说明
5. **测试功能**：确保伏笔添加、更新、删除功能正常工作

## 7. 技术要点

* 伏笔标识：使用伏笔名称作为唯一标识

* 时间格式：统一使用 YYYY-MM-DD HH:mm:ss 格式

* 数量管理：当伏笔数超过12时建议删除，超过20时强制删除

* 删除逻辑：超过12时删除最用不到的，超过20时删除权重最低的

* 错误处理：确保伏笔操作失败时不会影响游戏正常运行

* AI交互：通过清晰的指令格式，让AI能够正确使用伏笔机制

