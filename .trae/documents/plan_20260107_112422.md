# 重新设计聊天历史存储逻辑

## 目标

重新梳理储存历史的逻辑，明确区分并管理四个部分：完整故事、压缩故事、未压缩故事和最新消息，确保故事的完整性和API调用的效率，同时保证所有数据在本地持久化存储，不随刷新丢失。

## 具体步骤

1. **创建新文件** **`storyStorage.js`**

   * 实现故事存储管理模块，包含以下功能：

     * `saveFullStory()`: 保存完整故事到localStorage，不做删减

     * `saveCompressedStory()`: 保存压缩故事到localStorage

     * `saveUncompressedStory()`: 保存未压缩故事到localStorage

     * `saveLatestUserMessage()`: 保存最新用户消息到localStorage

     * `loadFullStory()`: 从localStorage加载完整故事

     * `loadCompressedStory()`: 从localStorage加载压缩故事

     * `loadUncompressedStory()`: 从localStorage加载未压缩故事

     * `loadLatestUserMessage()`: 从localStorage加载最新用户消息

     * `clearAll()`: 清空所有存储的故事数据

2. **修改** **`chat.html`** **文件**

   * 引入新的 `storyStorage.js` 文件

   * 使用新的存储管理模块管理故事数据

   * 修改 `addMessage` 函数，分别更新四部分数据

   * 修改初始化逻辑，从localStorage加载未压缩故事作为之前的故事

   * 修改显示逻辑，只显示未压缩故事（实时故事）的部分给玩家，并且让对话自然向下流动，不删除前面的部分

3. **修改** **`index.html`** **文件**

   * 添加继续故事的逻辑，从localStorage加载未压缩故事并显示给玩家

   * 处理未压缩故事为空的情况

4. **修改** **`contextCompressor.js`** **文件**

   * 更新压缩逻辑，确保压缩后的内容正确保存到压缩故事中

   * 与新的存储管理逻辑集成

5. **修改** **`promptBuilder_storyteller.js`** **文件**

   * 更新提示词生成逻辑，按照以下顺序拼凑：

     1. prompt.json

     2. data.json

     3. 压缩故事（compressedStory）

     4. 未压缩故事（uncompressedStory）

     5. 最新用户消息（latestUserMessage）

## 技术要点

* **模块化设计**：将存储管理逻辑分离到独立模块，提高代码可维护性

* **清晰的数据分离**：明确区分四种不同类型的故事数据

* **完整的故事保存**：确保完整故事不做删减，用于导出

* **自然的对话流动**：游玩过程中对话自然向下流动，不删除前面的部分

* **高效的API调用**：通过压缩和限制未压缩故事长度，确保API调用的效率

* **本地持久化存储**：所有数据都保存在localStorage中，不随刷新丢失

* **数据一致性**：确保四部分数据的同步和一致性

