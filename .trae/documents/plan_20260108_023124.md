# 时间线功能实现计划

## 1. 数据结构调整

### 1.1 修改 data.json

* 在 `metadata` 字段下添加 `currentTime` 字段，存储当前剧情时间

* 格式：`YYYY-MM-DD HH:mm:ss`

* 默认值：`1925-12-26 00:00:00`（1925年圣诞节后一天）

### 1.2 更新 dataManager.js

* 在 `getDefaultData()` 方法中添加默认时间设置为 `1925-12-26 00:00:00`

* 确保时间数据正确读写和更新

## 2. 核心功能实现

### 2.1 扩展 responseParser.js

* 添加 `time_set` 功能解析支持

* 在 `parseSimpleFormat()` 方法中添加时间设置解析

* 在 `validateRequest()` 方法中添加时间设置验证

### 2.2 修改 engine.js

* 添加时间处理逻辑

* 实现默认时间推进机制（根据景深等级）：

  * 景深 1: 推进 1 天

  * 景深 2: 推进 8 小时

  * 景深 3: 推进 2 小时

  * 景深 4: 推进 15 分钟

  * 景深 5: 推进 1 分钟

* **优先级处理**：AI设置时间的优先级高于默认事件推进，只有当AI设置时间失败时才使用默认推进

* 在 `processAIResponse()` 中处理时间设置，检查是否有AI设置的时间

* 在 `processDefaultDataRequests()` 中添加默认时间推进（仅当AI未设置时间时）

### 2.3 更新 promptBuilder\_storyteller.js

* 在系统提示词中添加"上次回复的剧情时间"

* 确保时间信息正确传递给 AI

## 3. 存储和压缩处理

### 3.1 修改 storyStorage.js

* 确保时间元数据正确存储在 uncompressed\_story 中

* 每个回复开始时添加时间标记

### 3.2 更新 contextCompressor.js

* 在压缩故事摘要时，提取其中每件事的时间点

* 确保时间信息在压缩后仍然可用

## 4. 提示词配置更新

### 4.1 修改 prompt.json

* 添加故事叙事守则：故事应当按照时间走向叙述，不应当回退、回到过去或突然跨越很长的时间

* 添加时间线工具使用方法：必须使用 timeset 工具设置"当前时间"，根据故事推进时间写出新的时间点

* 添加时间格式示例和使用指南

## 5. 实现步骤

1. **数据结构调整**：修改 data.json 和 dataManager.js，设置默认时间为 1925-12-26 00:00:00

2. **核心功能**：实现 responseParser.js 和 engine.js 的时间处理，确保AI设置时间优先级高于默认推进

3. **提示词更新**：修改 promptBuilder\_storyteller.js 和 prompt.json

4. **存储处理**：更新 storyStorage.js 和 contextCompressor.js

5. **测试验证**：确保时间线功能正常运行

## 6. 技术要点

* 时间格式统一使用 `YYYY-MM-DD HH:mm:ss`

* 默认时间设置为 1925年12月26日 00:00:00（圣诞节后一天）

* 时间推进算法根据景深等级动态调整

* **优先级机制**：AI设置时间优先，失败时才使用默认推进

* 确保时间信息在整个系统中正确传递和存储

* 提供清晰的时间线工具使用指南给 AI

* 保持与现有功能的兼容性

