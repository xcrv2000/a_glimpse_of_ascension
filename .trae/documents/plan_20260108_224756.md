# 节拍字数统计功能实现计划

## 1. 数据结构调整

### 1.1 修改 data.json

* 在 `narrative` 字段下添加 `beatStats` 字段，用于存储节拍字数统计

* 添加 `currentBeatCycle` 字段，用于标识当前节拍循环

* 添加 `totalWords` 字段，用于存储全局总字数

* 添加 `currentCycleWords` 字段，用于存储当前节拍循环的总字数

### 1.2 更新 dataManager.js

* 在 `getDefaultData()` 方法中添加默认的节拍统计数据结构

## 2. 核心功能实现

### 2.1 修改 chat.html

* 在 `addMessage()` 函数中添加字数统计逻辑，只统计进入 uncompressed story 的故事内容

* 区分用户消息和AI消息的字数统计

* 在保存故事数据前计算并更新字数统计

### 2.2 修改 engine.js

* 添加 `updateBeatWordCount()` 方法，用于更新当前节拍的字数统计

* 修改 `processStoryBeatOperation()` 方法，在节拍切换时初始化新节拍的字数统计

* 实现节拍循环的检测和管理

* 区分当前节拍循环的字数和全局字数

## 3. 提示词配置更新

### 3.1 修改 prompt.json

* 在节拍相关设置中添加节拍字数建议

* 添加一个节拍循环的建议字数范围（5-10万字）

* 添加故事前期和后期的四节拍字数建议占比

* 强调故事张力和情绪释放优先于节拍字数，但不应偏离太多

## 4. 实现步骤

1. **数据结构调整**：修改 data.json 和 dataManager.js，添加节拍统计数据结构
2. **核心功能**：实现 chat.html 中的字数统计逻辑和 engine.js 中的节拍管理
3. **提示词更新**：修改 prompt.json，添加节拍字数建议
4. **测试验证**：确保节拍字数统计功能正常运行

## 5. 技术要点

* **字数统计范围**：只统计进入 uncompressed story 的故事内容

* **节拍循环**：检测"起-承-转-合"的完整循环

* **数据区分**：明确区分当前节拍循环的字数和全局字数

* **AI 可见性**：确保 AI 在生成响应时能看到当前节拍循环内每个节拍的字数统计

* **灵活性**：确保字数统计不会限制故事的自然发展

