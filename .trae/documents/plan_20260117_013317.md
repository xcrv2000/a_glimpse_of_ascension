## 1. 设计思路

* **问题**：AI自己设置时间容易出错，需要设计更可靠的时间管理方式

* **解决方案**：使用"推进时间"命令替代直接设置时间，AI只需输出预计消耗时间，系统自动计算

## 2. 实现方案

### 2.1 统一命令格式

* 采用与其他命令一致的格式：`推进时间：[时间描述]`

* 支持复合时间单位，如"1小时零5分钟"、"2天3小时"等

### 2.2 在responseParser.js中添加新的解析逻辑

* 添加新的正则表达式匹配，解析AI输出的"推进时间：[时间描述]"信息

* 支持多种时间单位组合：天/日、小时/时、分钟/分、秒

* 将解析结果转换为毫秒，生成时间推进请求

### 2.3 更新engine.js

* 添加新的方法`advanceTime`，接收毫秒数作为参数，更新当前时间

* 在`processSingleRequest`中添加对`advanceTime`请求的处理

* 保留现有的默认时间推进逻辑：当AI没有输出推进时间时，根据景深等级自动推进

### 2.4 更新prompt_recorder.json和promptSimplified.json

* 删除AI自己设置时间的方法介绍

* 添加新的"推进时间"方法介绍，说明AI需要使用`推进时间：[时间描述]`格式

* 明确说明：如果AI没有输出推进时间，系统会根据景深等级自动推进时间

## 3. 具体实现细节

### 3.1 responseParser.js的修改

* 在`parseDataRequests`方法中添加新的正则表达式匹配：

  ```javascript
  // 匹配推进时间格式: 推进时间：[时间描述]
  const timeAdvanceMatch = trimmedLine.match(/^推进时间：(.+)$/);
  ```

* 解析复杂时间描述，转换为毫秒：

  ```javascript
  if (timeAdvanceMatch) {
      const timeDescription = timeAdvanceMatch[1];
      const advanceMs = this.parseTimeDescription(timeDescription);
      if (advanceMs > 0) {
          requests.push({
              action: 'advanceTime',
              value: advanceMs
          });
      }
      return;
  }
  ```

* 添加新的辅助方法`parseTimeDescription`，用于解析复杂时间描述：

  ```javascript
  // 解析时间描述，转换为毫秒
  static parseTimeDescription(description) {
      let totalMs = 0;
      
      // 匹配天/日
      const dayMatch = description.match(/(\d+)\s*(天|日)/);
      if (dayMatch) {
          totalMs += parseInt(dayMatch[1]) * 24 * 60 * 60 * 1000;
      }
      
      // 匹配小时/时
      const hourMatch = description.match(/(\d+)\s*(小时|时)/);
      if (hourMatch) {
          totalMs += parseInt(hourMatch[1]) * 60 * 60 * 1000;
      }
      
      // 匹配分钟/分
      const minuteMatch = description.match(/(\d+)\s*(分钟|分)/);
      if (minuteMatch) {
          totalMs += parseInt(minuteMatch[1]) * 60 * 1000;
      }
      
      // 匹配秒
      const secondMatch = description.match(/(\d+)\s*(秒)/);
      if (secondMatch) {
          totalMs += parseInt(secondMatch[1]) * 1000;
      }
      
      return totalMs;
  }
  ```

### 3.2 engine.js的修改

* 添加新的方法`advanceTime`，接收毫秒数作为参数，更新当前时间：

  ```javascript
  // 推进时间
  async advanceTime(advanceMs) {
      try {
          console.log('开始推进时间:', advanceMs);
          
          // 获取当前时间
          const currentTimeStr = this.gameData.currentTime || '1925-12-26 00:00:00';
          const currentTime = new Date(currentTimeStr.replace(' ', 'T') + 'Z');
          
          // 计算新时间
          const newTime = new Date(currentTime.getTime() + advanceMs);
          
          // 格式化时间为 YYYY-MM-DD HH:mm:ss
          const year = newTime.getUTCFullYear();
          const month = String(newTime.getUTCMonth() + 1).padStart(2, '0');
          const day = String(newTime.getUTCDate()).padStart(2, '0');
          const hours = String(newTime.getUTCHours()).padStart(2, '0');
          const minutes = String(newTime.getUTCMinutes()).padStart(2, '0');
          const seconds = String(newTime.getUTCSeconds()).padStart(2, '0');
          
          const formattedTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
          
          // 更新当前时间
          this.gameData.currentTime = formattedTime;
          
          console.log(`时间推进完成: ${currentTimeStr} → ${formattedTime}`);
          return { success: true };
      } catch (error) {
          console.error('推进时间错误:', error);
          return { success: false, error: error.message };
      }
  }
  ```

* 在`processSingleRequest`中添加对`advanceTime`请求的处理：

  ```javascript
  } else if (request.action === 'advanceTime') {
      await this.advanceTime(request.value);
  }
  ```

* **保留现有默认时间推进逻辑**：当AI没有输出推进时间时，系统会调用`calculateDefaultTime`方法，根据景深等级自动推进时间

### 3.3 prompt_recorder.json的修改

* 删除4.2节中的时间设置方法介绍

* 更新4.2节为"时间推进方法"：

  ```
  #### 4.2 时间推进方法
  - 必须使用 `推进时间：[时间描述]` 格式设置时间推进
  - 支持复合时间单位，如：
    - `推进时间：1小时零5分钟`
    - `推进时间：2天3小时`
    - `推进时间：30分钟`
  - **重要提示**：如果AI没有输出推进时间，系统会根据当前景深等级自动推进时间
  ```

* 更新4.3节，明确默认时间推进规则：

  ```
  #### 4.3 时间推进规则
  - 景深等级与默认时间推进的关系：
    - 景深 1: 大约推进 1 天
    - 景深 2: 大约推进 8 小时
    - 景深 3: 大约推进 2 小时
    - 景深 4: 大约推进 15 分钟
    - 景深 5: 大约推进 1 分钟
  - 只有当AI没有输出推进时间时，才会使用上述默认值
  ```

### 3.4 promptSimplified.json的修改

* 删除时间设置相关的介绍

* 添加新的"推进时间"方法介绍：

  ```
  - 推进时间：`推进时间：[时间描述]`
  ```

* 明确说明默认行为：如果AI没有输出推进时间，系统会根据景深等级自动推进时间

## 4. 预期效果

* AI不再需要自己设置具体时间，只需输出预计消耗时间

* 系统自动计算并更新当前时间，减少AI设置时间的错误率

* 支持复合时间单位，如"1小时零5分钟"、"2天3小时"等

* 保持时间线的连贯性和逻辑性

* 命令格式与其他命令保持一致，易于AI理解和使用

* 当AI忘记输出时间推进时，系统自动使用默认值，确保游戏正常运行

## 5. 文件修改列表

* `src/js/responseParser.js`：添加新的"推进时间"解析逻辑和辅助方法

* `src/js/engine.js`：添加新的`advanceTime`方法和请求处理，保留默认时间推进逻辑

* `src/data/prompt_recorder.json`：更新时间线系统的使用说明，明确默认行为

* `src/data/promptSimplified.json`：更新时间线系统的使用说明，明确默认行为

