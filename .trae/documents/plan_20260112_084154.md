# 两阶段AI交互逻辑实现计划

## 一、提示词文件准备

### 1. 拆分提示词文件

* 从 `archive/full_prompt.json` 拆分出【故事讲述者】和【故事记录者】提示词

* 创建新文件：

  * `src/data/prompt_storyteller.json` - 故事讲述者提示词

  * `src/data/prompt_recorder.json` - 故事记录者提示词

* 重命名现有 `src/data/prompt.json` 为 `src/data/promptSimplified.json`

### 2. 提示词内容优化

* 确保提示词保持人类可读性，不使用 `/n` 换行

* 故事讲述者提示词：专注于叙事，不包含引擎调用相关信息

* 故事记录者提示词：专注于解析故事并调用引擎更新状态

## 二、新的提示词构建器

### 1. 创建提示词管理模块

* `src/js/promptManager.js` - 提示词管理和模式切换

* 功能：

  * 加载不同模式的提示词

  * 管理提示词版本

  * 提供模式切换接口

### 2. 创建故事讲述者提示词构建器

* `src/js/promptBuilder_storyteller.js` (现有文件修改)

* 功能：

  * 拼装故事讲述者提示词

  * 处理秘密信息

  * 准备第一阶段API请求

### 3. 创建故事记录者提示词构建器

* `src/js/promptBuilder_recorder.js` (新建)

* 功能：

  * 拼装故事记录者提示词

  * 解析第一阶段结果

  * 准备第二阶段API请求

## 三、两阶段交互逻辑实现

### 1. 修改 `chat.html` 中的交互逻辑

* 更新 `sendMessage` 函数，实现两阶段交互：

  * 阶段一：发送故事讲述者提示词，获取故事和秘密信息

  * 阶段二：发送故事记录者提示词，更新游戏引擎状态

* 添加加载等待条UI：

  * "世界加载中" - 第一阶段

  * "世界解算中" - 第二阶段

### 2. 会话状态管理

* 实现会话状态检查功能：

  * 网页打开时检查之前的对话进度

  * 处理破碎的对话记录

  * 确保中断的会话不影响游戏

* 实现引擎状态同步逻辑：

  * 如果故事已生成但是没有被故事记录者记录，进行记录

## 四、设置界面更新

### 1. 修改设置界面

* 在 `settings.html` 中添加"简略模式"开关

* 实现模式切换逻辑：

  * 滑块控制，切换不同的提示词模式

  * 保存用户选择到本地存储

  * 默认处于完整模式。从index按下按钮进入chat.html时如果处于简略模式，弹窗提问是否进入简略模式。

### 2. 模式切换功能

* 实现不同模式下的提示词加载逻辑

* 确保模式切换不影响当前会话

## 五、代码架构优化

### 1. 模块化设计

* 按功能拆分代码，确保低耦合

* 提供清晰的接口和文档

### 2. 错误处理

* 增强错误处理机制，确保系统稳定性

* 实现会话恢复和错误修复功能

## 六、测试与调试

### 1. 功能测试

* 测试两阶段交互流程

* 测试会话状态恢复

* 测试模式切换功能

### 2. 性能优化

* 优化提示词加载速度

* 优化API请求效率

* 确保加载等待条的流畅显示

## 七、实现步骤

1. **准备提示词文件**
2. **创建新的提示词构建器模块**
3. **实现两阶段交互逻辑**
4. **更新设置界面**
5. **实现会话状态管理**
6. **测试和调试**
7. **性能优化**

